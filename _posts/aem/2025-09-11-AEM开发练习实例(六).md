---
layout: post
title: "AEM开发系列-开发练习实例(六)"
categories: AEM开发系列
tags: AEM
author: fengsh998
typora-root-url: ..
---

基础了解：

***cq:editConfig***
结点属性有：

***cq:actions***: String[] 定义可以对组件执行的操作,常见的值有edit,delete,insert,copymove
![img](/assets/articles/aem/lesson2/l1-1.jpg)
***cq:layout***: String，(只有经典UI时才生效)定义如何在经典UI中编辑组件。

***cq:emptyText***: String，定义不存在可视内容时显示的文本。

***cq:inherit***: Boolean，定义缺少的值是否从它继承的组件继承。

***cq:dialogMode***: String，(只有经典UI时才生效)定义如何在经典UI中打开组件对话框。
子结点有：

* ***cq:dropTargets***:nt:unstructured，定义可以从内容查找器的资源中接受放置的放置目标的列表

* ***cq:actionConfigs***:nt:unstructured（仅限经典UI）定义附加到cq:actions列表的新操作列表。

* ***cq:formParameters***:nt:unstructured 定义添加到对话框表单的其他参数。

* ***cq:inplaceEditing***:为组件定义就地编辑配置。

* ***cq:listeners***:定义在组件上发生操作之前或之后发生的情况。
[官网连接](https://experienceleague.adobe.com/zh-hans/docs/experience-manager-65-lts/content/implementing/developing/components/components-basics#edit-behavior)

## 练习一：扩展一个核心组件
***步聚：***

1、打开工程目录，找到<AEM Project>/ui.apps/src/main/content/jcr_root/apps/wetrain/components。

2、找到embed目录右键copy，然后粘贴，重命名为hero。

![img](/assets/articles/aem/lesson2/l2-1.jpg)

3、修改hero文件夹下的.content.xml中的jcr:title="Hero", sling:resourceSuperType="core/wcm/components/image/v2/image"

4、在hero文件夹下创建一个hero.html,内容如下：
```html
<div data-sly-use.template="core/wcm/components/commons/v1/templates.html" 
    data-sly-test.hasContent="${properties.fileReference}"
    class="">
</div>

<sly data-sly-call="${template.placeholder @ isEmpty=!hasContent}"></sly>
```
5、mvn clean install -PautoInstallSinglePackage 进行安装组件。

6、验证组件是否安装成功，打开AEM 站点交互页，如原来的helloworld页。
![img](/assets/articles/aem/lesson2/l2-2.jpg)
附：上面的流程不一定需要复制而来，也可从CRXDE来创建。

## 练习二：自定义属性对话框cq:dialog
***前言***

由于练习一时已经创建了hero，并且sling:resourcSuperType为v2/image,用的是WCM核心的Image组件，所以默认情况下会有一个dialog。此时打开的实际上是Image的属性对话框，如图：

![img](/assets/articles/aem/lesson2/lesson2-1.jpg)

下面是自定义Hero组件的属性对话框
***步聚***：

1、打开CRXDE lite, /libs/core/wcm/components/image/v2/image。

2、Copy 一个cq:dialog结点，到hero结点下粘贴。

![img](/assets/articles/aem/lesson2/lesson2-2.jpg)

3、删除cq:dialog结点中的属性，删除helpPath, extraClientlibs,trackingFeature, 同时修改jcr:title=Hero

![img](/assets/articles/aem/lesson2/lesson2-3.jpg)

4、展开/apps/wetrain/components/hero/cq:dialog/content/items/tabs/items，删除asset结点，同时复制metadata结点，在items下粘贴重命名为hero结点，设置jcr:title为Hero

![img](/assets/articles/aem/lesson2/lesson2-4.jpg)

5、展开重命名的hero结点，/apps/wetrain/components/hero/cq:dialog/content/items/tabs/items/hero/items/columns/items/column/items，删除dynamicmediaGroup, decorative, alternativeGroup,id等属性。

![img](/assets/articles/aem/lesson2/lesson2-5.jpg)

6、选中cationGroup,展开找到caption结点，重命名为heroTitle, 并修改fieldLabel属性值为Hero Title

![img](/assets/articles/aem/lesson2/lesson2-6.jpg)

7、选中heroTitle的父结点items，创建一个linkText的nt:unstructured 结点，并添加属性如下：

| 属性 | 类型 | 值 | 说明 |
|-----|----|----|------|
|sling:resourceType|String|granite/ui/components/coral/foundation/form/textfield| 使用的UI组件类型 |
|fieldLabel|String|Link Text| 标签 |
|name|String|./linkText| 存放的字段名 |

![img](/assets/articles/aem/lesson2/lesson2-7.jpg)
8、save all, 找到/apps/wetrain/components/hero/cq:dialog/content/items/tabs/items/metadata，添加属性，sling:hideResource      Boolean 设为true,即隐藏该结点，同时删除metadata的子结点items

![img](/assets/articles/aem/lesson2/lesson2-8.jpg)

9、使用IDE的插件工具，将CRXDE的组件同步到开发代码IDE。

10、修改代码中的hero.html，内容如下：
```html
<div data-sly-use.template="core/wcm/components/commons/v1/templates.html" 
    data-sly-test.hasContent="${properties.fileReference}"
    class="">

    <!--/* Display the hero image */-->	
    <img class="" src="${properties.fileReference}"/>

    <!--/* Display a hero title and optional call to action link */-->
    <div class="">
        <h1 class="">${properties.jcr:title}</h1>
        <div class="" data-sly-test="${properties.linkText}">
            <a href="${properties.linkURL}">${properties.linkText}</a>
        </div>
    </div>
</div>

<!--/* If there is no content entered into the dialog, show a placeholder. */-->
<sly data-sly-call="${template.placeholder @ isEmpty=!hasContent}"></sly>
```
11、mvn clean install -PautoInstallSinglePackage。

12、打开AEM的交互平台，拖放一个hero组件，查看他的属性对话框。

![img](/assets/articles/aem/lesson2/lesson2-9.jpg)

13、测试组件的显示情况，选中Asset , 然后拖放一张图片进来。

![img](/assets/articles/aem/lesson2/lesson2-10.jpg)

14、选中Hero的tabs, 把Get Caption from DAM的勾去除，然后就可以修改Hero Title, 而link是指点击图片跳转，根据自己的需求设置测试即可。

![img](/assets/articles/aem/lesson2/lesson2-11.jpg)

## 练习三：为组件添加拖放组件的默认配置
***步聚***：

1、复制/libs/core/wcm/components/image/v2/image/cq:editConfig。

2、到代理组件的hero下粘贴。
![img](/assets/articles/aem/lesson2/lesson3-1.jpg)
3、展开所有结点。
![img](/assets/articles/aem/lesson2/lesson3-2.jpg)
4、对cq:dropTargets/image结点进行修改accept属性，双击，删除其它图片的后缀，只保留jpeg的后缀。
![img](/assets/articles/aem/lesson2/lesson3-3.jpg)
5、将cq:dropTargets/image/parameters结点，添加属性。
sling:resourceType    String   wetrain/components/hero

6、删除cq:editConfig下的cq:inplaceEditing子结点。并save all。
![img](/assets/articles/aem/lesson2/lesson3-4.jpg)
7、将结构同步到开发代码，然后执行mvn clean install -PautoInstallSinglePackage。

8、验证组件,在页面上添加hero组件，从Assets里找一张非jpeg或jpg的图片拖进hero,此时应该不能加载，只有jpeg才能正常拖放。


## 练习四：给组件添加样式设计
***步聚***：

1、修改hero.html,(/apps/wetrain/components/hero/hero.html) 内容如下：
```html
<div data-sly-use.template="core/wcm/components/commons/v1/templates.html" 
    data-sly-test.hasContent="${properties.fileReference}"
    class="cmp-hero">

    <!--/* Display the hero image */-->	
    <img class="cmp-hero__image" src="${properties.fileReference}"/>

    <!--/* Display a hero title and optional call to action link */-->
    <div class="cmp-hero__content">
        <h1 class="cmp-hero__title">${properties.jcr:title}</h1>
        <div class="cmp-hero__link" data-sly-test="${properties.linkText}">
            <a href="${properties.linkURL}">${properties.linkText}</a>
        </div>
    </div>
</div>

<!--/* If there is no content entered into the dialog, show a placeholder. */-->
<sly data-sly-call="${template.placeholder @ isEmpty=!hasContent, classAppend='cmp-hero'}"></sly>
```
2、在ui.frontend下的components下新建hero文件夹，再新建一个_hero.scss，内容如下：
```scss
@use 'sass:math' as math;
    
$hero-height: 400px;
$hero-content-bottom: $hero-height * .35;
$hero-content-width: 70%;
$hero-content-left: math.div(100-$hero-content-width,2);

.cmp-hero {
    position: relative;
    max-height: $hero-height;
    overflow: hidden;
    margin: 1px;
    .cmp-hero__image {
        filter: blur(1px);
        width: 100%;
    }
    .cmp-hero__content{
        position: absolute;
        bottom: $hero-content-bottom;
        color: #fff;
        width: $hero-content-width;
        left: $hero-content-left;
        text-align: center;
        .cmp-hero__link a {
            color: #fff;
            border: 1px solid #fff;
            padding: 1em;
            text-decoration: none;
            background-color: transparent;
            -webkit-transition: all .25s ease-out;
            -moz-transition: all .25s ease-out;
            -o-transition: all .25s ease-out;
            transition: all .25s ease-out;
        }
        .cmp-hero__link:hover a{
            background-color: #ffea00;
            border: 1px solid #000; 
            color: #000;
        }
    }
    
}
```
3、保存，编译安装。

4、验证，拖放hero组件，然后输入link Text。看到组件的样式发生了变化。连接字段居中显示了。

![img](/assets/articles/aem/lesson2/lesson4-1.jpg)

## 练习五：构建headless的Sling Models组件。
***步聚***：

1、在core的java项目（core/src/main/java/<your-package-name>/models）下创建一个Hero.java的model文件。
```java
package com.adobe.training.core.models;

import javax.annotation.PostConstruct;

//This Hero model extends the core Image component
import com.adobe.cq.wcm.core.components.models.Image;

import com.day.cq.wcm.api.Page;
import com.day.cq.wcm.api.components.ComponentContext;
import org.apache.sling.api.SlingHttpServletRequest;
import org.apache.sling.api.resource.Resource;
import org.apache.sling.models.annotations.Default;
import org.apache.sling.models.annotations.Model;
import org.apache.sling.models.annotations.Via;
import org.apache.sling.models.annotations.injectorspecific.OSGiService;
import org.apache.sling.models.annotations.injectorspecific.ScriptVariable;
import org.apache.sling.models.annotations.injectorspecific.Self;
import org.apache.sling.models.annotations.injectorspecific.ValueMapValue;
import org.apache.sling.models.annotations.via.ResourceSuperType;
import org.apache.sling.models.factory.ModelFactory;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

// Imports added to support Adobe Client Data Layer enablement and population
import com.adobe.cq.wcm.core.components.models.datalayer.ComponentData;
import com.adobe.cq.wcm.core.components.models.datalayer.builder.DataLayerBuilder;
import com.adobe.cq.wcm.core.components.util.ComponentUtils;

@Model(
    adaptables=SlingHttpServletRequest.class,		
    adapters= Image.class,
    resourceType = Hero.RESOURCE_TYPE 
)
public class Hero implements Image{
    protected static final String RESOURCE_TYPE = "wetrain/components/hero";
    private static final Logger LOGGER = LoggerFactory.getLogger(Hero.class);
    
    //Annotations to help extend the data layer enablement and population
    @Self
    private SlingHttpServletRequest request;
    
    // @OSGiService
    // private ModelFactory modelFactory;
    
    //Core Image model we are extending
	@Self 
    @Via(type = ResourceSuperType.class)
	private Image coreImage;

    @ScriptVariable
    protected ComponentContext componentContext;
    @ScriptVariable
    private Page currentPage;
    @ScriptVariable
	private Resource resource;

    //property on the current resource saved from the dialog of a component
	@ValueMapValue @Default(values="")
	private String linkText;

    //A method to make any calculations before values are returned
    @PostConstruct
    private void init() {
        // Add any needed business logic here.
    }
    
    public String getLinkText() {
        return linkText;
    }

    @Override
    public String getLink() {
        if(coreImage.getImageLink() != null) return coreImage.getImageLink().toString();
        return "";
    }

    @Override
    public String getTitle() {
        if(coreImage.getTitle() != null) return coreImage.getTitle();
        return "";
    }
    
    @Override
    public String getSrc() {
        if(coreImage.getSrc() != null) return coreImage.getSrc();        
        return "";
    }

    @Override
    public String getAlt() {
        if(coreImage.getAlt() != null) return coreImage.getAlt();
        return "";
    }

    public boolean isEmpty() {
        String src = coreImage.getSrc();
        if(src != null && !src.isEmpty()){
            return false;
        }
        LOGGER.info("Hero component has no content");
        return true;
    }

    @Override
    public String getExportedType() {
        return request.getResource().getResourceType();
    }

    /**
     * This is the method that will return relevant data from the Hero component 
     * to the Adobe Client Data Layer
     */
    @Override
    public ComponentData getData() {
        Resource heroResource = request.getResource();
        if (ComponentUtils.isDataLayerEnabled(heroResource)) {
            return DataLayerBuilder.extending(coreImage.getData()).asImageComponent()
                .withId(this::getId)
                .withTitle(this::getTitle)
                .withLinkUrl(this::getLink)
                .withType(() -> RESOURCE_TYPE)
                .build();
        }
        return null;
    }

    /**
     * Get the uniqueID of the hero component
     * This method is used by the getData() method to uniquely identify the output to the data layer
     */
    @Override
    public String getId() {
        Resource heroResource = this.request.getResource();
        return ComponentUtils.getId(heroResource, this.currentPage, this.componentContext);
    }
}
```
![img](/assets/articles/aem/lesson2/lesson5-1.jpg)

2、修改ui.apps下的hero组件中的hero.html文件。内容如下：
通过data-sly-use.hero="com.adobe.training.core.models.Hero" 来绑定JAVA的model
```html
<div data-sly-use.hero="com.wetrain.core.models.Hero"
    data-sly-use.template="core/wcm/components/commons/v1/templates.html" 
    data-sly-test.hasContent="${!hero.empty}"
    data-cmp-data-layer="${hero.data.json}"
    class="cmp-hero">

    <!--/* Display the hero image */-->	
    <img class="cmp-hero__image" alt="${hero.alt}" src="${hero.src}"/>

    <!--/* Display a hero title and optional call to action link */-->
    <div class="cmp-hero__content">
        <h1 class="cmp-hero__title">${hero.title}</h1>
        <div class="cmp-hero__link" data-sly-test="${hero.linkText}">
            <a href="${hero.link}">${hero.linkText}</a>
        </div>
    </div>
</div>

<!--/* If there is no content entered into the dialog, show a placeholder. */-->
<sly data-sly-call="${template.placeholder @ isEmpty=!hasContent, classAppend='cmp-hero'}"></sly>
```
3、编译安装。

4、打开AEM, site -> wetrain -> us -> en ,点击edit， 拖放一个hero,然后在Asset拖个图片上来，同时通过属性设置link。然后保存。

5、通过http://localhost:4502/content/wetrain/us/en.model.json，搜索hero则可以找到hero的相关json

![img](/assets/articles/aem/lesson2/lesson5-2.jpg)
上面的方只是简单能过html进行绑定model的方式，如果想实用性的headless，则需要写servlet接口的方式来读取。

## 练习六：组件对话框输入验证
***步聚***：

1、参考之前的练习，快速开发一个stockplex的组件。
stockplex.html内容如下：
```html
<div data-sly-use.template="core/wcm/components/commons/v1/templates.html" 
    data-sly-test.hasContent="${properties.symbol}"
    class="">

    <!--/* Only displayed if authored content is added 
        data-sly-test.hasContent is a test to see if certain content exists.
        Since there is no dialog, it's set to false to force the placeholder to show.*/-->	
</div>

<!-- If there is no stock symbol added to the dialog, create a component placeholder -->
<sly data-sly-call="${template.placeholder @ isEmpty=!hasContent}"></sly>
```
![img](/assets/articles/aem/lesson2/lesson6-1.jpg)
属性对话框.content.xml如下：
```xml
<?xml version="1.0" encoding="UTF-8"?>
<jcr:root xmlns:jcr="http://www.jcp.org/jcr/1.0" xmlns:nt="http://www.jcp.org/jcr/nt/1.0" xmlns:cq="http://www.day.com/jcr/cq/1.0" xmlns:sling="http://sling.apache.org/jcr/sling/1.0"
    jcr:primaryType="nt:unstructured"
    jcr:title="Stockplex"
    sling:resourceType="cq/gui/components/authoring/dialog"
    extraClientlibs="[we.train.stockplex.editor]">
    <content
        jcr:primaryType="nt:unstructured"
        sling:resourceType="granite/ui/components/coral/foundation/container">
        <items jcr:primaryType="nt:unstructured">
            <tabs
                jcr:primaryType="nt:unstructured"
                sling:resourceType="granite/ui/components/coral/foundation/tabs"
                maximized="{Boolean}true">
                <items jcr:primaryType="nt:unstructured">
                    <properties
                        jcr:primaryType="nt:unstructured"
                        jcr:title="Properties"
                        sling:resourceType="granite/ui/components/coral/foundation/container"
                        margin="{Boolean}true">
                        <items jcr:primaryType="nt:unstructured">
                            <columns
                                jcr:primaryType="nt:unstructured"
                                sling:resourceType="granite/ui/components/coral/foundation/fixedcolumns"
                                margin="{Boolean}true">
                                <items jcr:primaryType="nt:unstructured">
                                    <column
                                        jcr:primaryType="nt:unstructured"
                                        sling:resourceType="granite/ui/components/coral/foundation/container">
                                        <items jcr:primaryType="nt:unstructured">
                                            <symbol
                                                jcr:primaryType="nt:unstructured"
                                                sling:resourceType="granite/ui/components/coral/foundation/form/textfield"
                                                fieldDescription="Enter a 4 character stock symbol"
                                                fieldLabel="Stock Symbol"
                                                name="./symbol"/>
                                            <summary
                                                jcr:primaryType="nt:unstructured"
                                                sling:resourceType="granite/ui/components/coral/foundation/form/textfield"
                                                fieldDescription="Enter a summary description of the stock"
                                                fieldLabel="Summary of Stock"
                                                name="./summary"/>
                                        </items>
                                    </column>
                                </items>
                            </columns>
                        </items>
                    </properties>
                </items>
            </tabs>
        </items>
    </content>
</jcr:root>
```
对话框效果：
![img](/assets/articles/aem/lesson2/lesson6-2.jpg)
此时如果输入内容时，将不会显示。
![img](/assets/articles/aem/lesson2/lesson6-3.jpg)
2、修改stockplex.html，把通过对话框设置的值读出来。
```html
<div data-sly-use.template="core/wcm/components/commons/v1/templates.html"
     data-sly-test.hasContent="${properties.symbol}"
     class="">

    <div class="">${properties.symbol}</div>
    <div class="">Current Value: 300</div>

    <div data-sly-test.summary="${properties.summary}">
        <h3>Summary: ${properties.summary}</h3>
    </div>

    <div class="">
        <a href="#">
            <button>Placeholder</button>
        </a>
    </div>

    <ul data-sly-list.sInfo="${['Request Date','Open Price', 'Range High', 'Range Low', 'Close', 'Volume']}">
        <li class="">
            <span class="">${sInfo}: value</span>
        </li>
    </ul>
</div>

<!-- If there is no stock symbol added to the dialog, create a component placeholder -->
<sly data-sly-call="${template.placeholder @ isEmpty=!hasContent}"></sly>
```
效果：
![img](/assets/articles/aem/lesson2/lesson6-4.jpg)
3、前面的对话框随便输入都没有较验和限制，接下需要添加对话框输入验证。
在CRXDE中/apps/wetrain/components/stockplex，<font color='red'>创建一个文件夹clientlibs</font>,然后在clientlibs下创建一个名为editor的<font color='red'>cq:ClientLibraryFolder</font>。同时指定<font color='red'>categories</font>属性值为<font color='red'>we.train.stockplex.editor</font>
在editor下新建js.txt和js文件夹，js文件夹下创建一个validation.js
![img](/assets/articles/aem/lesson2/lesson6-5.jpg)
js.txt
```plain
js/validation.js
```
validation.js
```javascript
(function (document, $, ns) {
    "use strict";
 
    $(document).on("click", ".cq-dialog-submit", function (e) {
        e.stopPropagation();
        e.preventDefault();
 
        var $form = $(this).closest("form.foundation-form"),
            symbolid = $form.find("[name='./symbol']").val(),
               message, clazz = "coral-Button ",
         patterns = {
             symboladd: /^([a-z][a-z][a-z][a-z])\.?$/i
        };
 
        if(symbolid != "" && !patterns.symboladd.test(symbolid) && (symbolid != null)) {
                ns.ui.helpers.prompt({
                title: Granite.I18n.get("Invalid Input"),
                message: "Please Enter a valid 4 Letter Stock Symbol",
                actions: [{
                    id: "CANCEL",
                    text: "CANCEL",
                    className: "coral-Button"
                }],
            callback: function (actionId) {
                if (actionId === "CANCEL") {
                }
            }
        });
 
        }else{
                 $form.submit();
        }
    });
})(document, Granite.$, Granite.author);
```
检测stockplex/cq:dialog结点属性extraClientlibs 中的值是否为we.train.stockplex.editor，因为在editor文件夹时已经设置了categories的值了，两个必须对应上才能加载。
效果：
![img](/assets/articles/aem/lesson2/lesson6-6.jpg)
来复盘js中的代码：
$(document).on("click", ".cq-dialog-submit", function (e) {}
这句的意思是监听元素cq-dialog-submit的点击事件，然后执行function.
通过页面元素查询，可以看到点击done时，正好被监听到。
![img](/assets/articles/aem/lesson2/lesson6-7.jpg)
![img](/assets/articles/aem/lesson2/lesson6-8.jpg)

## 练习七：给组件添加内容策略对话框(Design_Dialog)
***步聚***：

1、copy 目录/libs/core/wcm/components/title/v3/title 中的cq:design_dialog结点。

2、粘贴到/apps/wetrain/components/stockplex组件下,同时修改cq:design_dialog属性jcr:title=Stockplex,
删除extraClientlibs，helpPath属性，再后save all。

3、展开design_dialog节点cq:design_dialog/content/items/tabs/items，然后将size节点重命名为stocktab。同时修改jcr:title属性值为Stock Info。

4、继续展开stocktab/items/column/items/inputgroup,修改inputgroup的jcr:title属性值为Optional Content to Present，save all。

5、删除inputgroup的兄结点field,type，将disableLink重命名为stockdetails，同时修改stockdetails的属性fieldDescription值为"Include requestDate,upDown,openPrice,range high/low,and volume"，name的属性值修改为./showStockInfo，text的属性值改为Include Stock Information，save all。

![img](/assets/articles/aem/lesson2/lesson7-1.jpg)

6、在AEM站点交互页面找到任何一个在stockplex的页面，选page information -> edit Template->在allowed components里找到stockplex，此时可以看到有个policy的图标，点击将会看到design_dialog的效果。

![img](/assets/articles/aem/lesson2/lesson7-2.jpg)
![img](/assets/articles/aem/lesson2/lesson7-3.jpg)
![img](/assets/articles/aem/lesson2/lesson7-4.jpg)
7、将CRXDE的组件结构同步回代码工程。然后再编译安装。

8、如何读取policy页面Proerties设置的内容值呢？通过全局HTL属性currentStyle,前面我们将stockdetails的name设置存储字段为showStockInfo，此结点为checkbox，因此存放的是Boolean类型的值。

![img](/assets/articles/aem/lesson2/lesson7-5.jpg)
修改stockplex.html添加读取showStockInfo的代码，完整html内容如下：
```html
<div class="">${properties.symbol}</div>
<div class="">Current Value: 300</div>

<div data-sly-test.summary="${properties.summary}">
    <h3>Summary: ${properties.summary}</h3>
</div>

<div class="">
    <a href="#">
        <button>Placeholder</button>
    </a>
</div>

<!-- 使用全局HTL对象currentStyle读取policy的设置 -->
<div class="" data-sly-test.summary="${currentStyle.showStockInfo}">
    <ul data-sly-list.sInfo="${['Request Date','Open Price', 'Range High', 'Range Low', 'Close', 'Volume']}">
        <li class="">
            <span class="">${sInfo}: value</span>
        </li>
    </ul>
</div>
```
测试验证，打开policy，添加一个策略，把include stock information 勾上。
![img](/assets/articles/aem/lesson2/lesson7-6.jpg)
打勾前展示：
![img](/assets/articles/aem/lesson2/lesson7-7.jpg)
打勾后效果：
![img](/assets/articles/aem/lesson2/lesson7-8.jpg)


## 练习八：组件添加样式效果(Stockplex)
前面的练习已经设计了一个组件，这节练习如何美化组件
***步聚***：

1、打开开发代码工程目录ui.frontend下的components目录。新建一个stockplex文件夹，文件夹下新建_stockplex.scss文件。

![img](/assets/articles/aem/lesson2/lesson8-1.jpg)
```scss
.cmp-stockplex--bold {
  font-weight: bold;

  h3 {
    font-weight: bold;
  }
}

.cmp-stockplex--italic {
  font-style: italic;

  button {
    font-style: italic;
  }
}

.cmp-stockplex--uppercase {
  text-transform: uppercase;

  button {
    text-transform: uppercase;
  }
}

.cmp-stockplex {
  overflow: auto;
  padding: 10px;
  font-size: 20px;
  margin: 10px;

  /* Stock Info Column */
  .cmp-stockplex__column1 {
    width: 33%;
    float: left;
    .cmp-stockplex__symbol {
      padding-right: 40px;
      font-size: 40px;
    }
    .cmp-stockplex__currentPrice {
      font-size: 25px;
    }
    .cmp-stockplex__button button:hover {
      background: #fff28c;
      border-color: #fff;
    }
    .cmp-stockplex__button button {
      background-color: #ffe72b;
      font-size: 16px;
      border-bottom-width: medium;
      border-right-width: medium;
      border-color: #a8981d;
      padding: .75em 3.5em;
      font-weight: 700;
    }
  }

  /* Details column */
  .cmp-stockplex__column2 {
    width: 66%;
    float: left;
    .cmp-stockplex__details ul {
      list-style-type: none;
    }
    .cmp-stockplex__details-item {
      width: 50%;
      float: left;
    }
    .cmp-stockplex__details-title {
      font-size: 15px;
    }
    .cmp-stockplex__details-value {
      font-size: 25px;
    }
  }

  /* Tablet view */
  @media(max-width: 1200px) {

    .cmp-stockplex__column1,
    .cmp-stockplex__column2 {
      width: 100%;
      text-align: center;
    }

    .cmp-stockplex__symbol,
    .cmp-stockplex__currentPrice,
    .cmp-stockplex__summary {
      width: 100%;
      padding: 0;
      float: left;
    }

    .cmp-stockplex__details ul {
      clear: left;
      padding-left: 0px;
    }
  }

  /* Phone view */
  @media(max-width: 650px) {
    .cmp-stockplex__details-item {
      width: 100%;
    }
  }
}
```
2、修改ui.apps 项目下的stockplex组件中的stockplex.html，给标签添加上样式，完整内容如下：
```html
<div data-sly-use.template="core/wcm/components/commons/v1/templates.html" 
    data-sly-test.hasContent="${properties.symbol}"
    class="cmp-stockplex">

    <div class="cmp-stockplex__column1">
        <div class="cmp-stockplex__symbol">${properties.symbol}</div>
        <div class="cmp-stockplex__currentPrice">Current Value: 300</div>

        <div class="cmp-stockplex__summary" data-sly-test.summary="${properties.summary}">
            <h3>Summary: ${properties.summary}</h3>
        </div>

        <div class="cmp-stockplex__button">
            <a href="#">
                <button>Placeholder</button>
            </a>
        </div>
    </div>

    <div class="cmp-stockplex__column2">
        <div class="cmp-stockplex__details" data-sly-test.summary="${currentStyle.showStockInfo}">
            <ul data-sly-list.sInfo="${['Request Date','Open Price', 'Range High', 'Range Low', 'Close', 'Volume']}">
                <li class="cmp-stockplex__details-item">
                    <span class="cmp-stockplex__details-title">${sInfo}: </span>
                    <br />
                    <span class="cmp-stockplex__details-data">Value</span>
                </li>
            </ul>
        </div>
    </div>
</div>

<!-- If there is no stock symbol added to the dialog, create a component placeholder -->
<sly data-sly-call="${template.placeholder @ isEmpty=!hasContent, classAppend='cmp-stockplex'}"></sly>
```
3、mvn clean install -PautoInstallSinglePackage 编译安装，刷新组件所在页面查看效果。
![img](/assets/articles/aem/lesson2/lesson8-2.jpg)


## 练习九：给组件添加设计时动态修改组件样式功能
组件是否可以添加样式主要是靠CRXDE中的cq:design_dialog中是带了开启了style设置，这个style结点几乎是AEM提供的一套设置界面，因此只需要从其它有样式设置的结点copy过来就可以用了。
比如结点名：styletab 属性如下：
|属性|类型|值|说明|
|---|----|---|---|
|jcr:primaryType|Name|nt:unsturctured| 结点类型 |
|path|String|/mnt/overlay/cq/gui/components/authoring/dialog/style/tab_design/styletab|  |
|sling:resourceType|String |granite/ui/components/coral/foundation/include| UI组件 |

![img](/assets/articles/aem/lesson2/lesson9-1.jpg)
出来的效果：
![img](/assets/articles/aem/lesson2/lesson9-2.jpg)
***步聚***：

1、打开组件的Policy，然后在styles页，在Allowed Styles 点Add添加样式, 输入Font Types 把style can be combined勾上。然后添加3个样式名和值，具体的css样式值看练习八，已经安装到AEM了，这里直接使用即可。
ltalic        cmp-stockplex--italic
Bold        cmp-stockplex--bold
uppercase  cmp-stockplex--uppercase
![img](/assets/articles/aem/lesson2/lesson9-3.jpg)
2、打开设计组件的工具要，可以看出现了样式笔的图标，样式笔是否出现在于是否添加了style样式。
![img](/assets/articles/aem/lesson2/lesson9-4.jpg)
点击样式笔出现添加的三个样式选项，然后随便选一个看组件是否能正常变化。
![img](/assets/articles/aem/lesson2/lesson9-5.jpg)
![img](/assets/articles/aem/lesson2/lesson9-6.jpg)
是否可以多选就是由style can be combined 这个勾决定的，如果不打勾，则能单选。

## 练习十：组件国际化

![img](/assets/articles/aem/lesson2/lesson10-1.jpg)
***步聚***：

1、修改stockplex.html，使用HTL语言规则添加读取i18n的语言设置。
${'Current Value:' @ i18n} ${properties.currentPrice}
${'Summary:' @ i18n} ${properties.summary}
${sInfo @ i18n}

```html
<div data-sly-use.template="core/wcm/components/commons/v1/templates.html" 
    data-sly-test.hasContent="${properties.symbol}" 
    class="cmp-stockplex">

    <div class="cmp-stockplex__column1">
        <div class="cmp-stockplex__symbol">${properties.symbol}</div>
        <div class="cmp-stockplex__currentPrice">${'Current Value:' @ i18n} ${properties.currentPrice}</div>


        <div class="cmp-stockplex__summary" data-sly-test.summary="${properties.summary}">
            <h3>${'Summary:' @ i18n} ${properties.summary}</h3>
        </div>

        <div class="cmp-stockplex__button">
            <a href="#">
                <button>Placeholder</button>
            </a>
        </div>
    </div>
    <div class="cmp-stockplex__column2">
        <div class="cmp-stockplex__details" data-sly-test="${currentStyle.showStockInfo}">
            <ul data-sly-list.sInfo="${['Request Date','Open Price', 'Range High', 'Range Low', 'Close', 'Volume']}">
                <li class="cmp-stockplex__details-item">
                    <span class="cmp-stockplex__details-title">${sInfo @ i18n}: </span>
                    <br />
                    <span class="cmp-stockplex__details-data">Value</span>
                </li>
            </ul>
        </div>
    </div>
</div>

<!-- If there is no stock symbol added to the dialog, create a component placeholder -->
<sly data-sly-call="${template.placeholder @ isEmpty=!hasContent, classAppend='cmp-stockplex'}"></sly>
```
2、打开代码开发工程，导航到ui.apps项目下的i18n文件夹，默认情况下，在创建工程时会生成一个fr.json法语环境。默认的示例json结构：
```json
{
  "&amp;copy; {0} wetrain Site. All rights reserved." : "&amp;copy; {0} wetrain Site. Tous droits réservés."
}
```
采用的是key:value结构的方式。
key 即被匹配翻译的字符串，value是在对应的语种中翻译后的字符串。
![img](/assets/articles/aem/lesson2/lesson10-2.jpg)
如：在fr.json添加我们示例的法语翻译
![img](/assets/articles/aem/lesson2/lesson10-3.jpg)
```javascript
{
  "Summary:": "Sommaire:",
  "Current Value:": "Valeur courante:",
  "Headless JSON View": "Vue JSON sans tête",
  "52 Week Low": "Min. année écoulée",
  "52 Week High": "Max. année écoulée",
  "Sector": "Secteur",
  "Company": "Société",
  "Volume": "Volume",
  "Range Low": "Fourchette basse",
  "Range High": "Fourchette haute",
  "Open Price": "Prix d'ouverture",
  "Up/Down": "Haut/Bas",
  "Request Time": "Heure de demande",
  "Request Date": "Date de demande"
}
```
3、编译安装，在CRXDE中查看/apps/wetrain/i18n目录，表示安装成功。注意观察fr.json的结点属性：

***jcr:language=fr***; 用来约束此文件使用的是法语。

***jcr:mixinTypes=mix:language*** ：用来约束此文件作为语方翻译文件。
![img](/assets/articles/aem/lesson2/lesson10-4.jpg)
4、使用设置的语言。
刷新之前us/en环境下的stockplex所在的页面http://localhost:4502/editor.html/content/wetrain/us/en/helloworld.html
由于当前的是en环境，即英语环境所以打开并没有看到相关语种切换。
![img](/assets/articles/aem/lesson2/lesson10-5.jpg)
因此我们需要新建一个fr的语种页面，打开http://localhost:4502/sites.html/content/wetrain/us，新建一个以current Page为模板的页面;title为French,Name为fr。
![img](/assets/articles/aem/lesson2/lesson10-6.jpg)
![img](/assets/articles/aem/lesson2/lesson10-7.jpg)
5、编辑这个fr页面，拖放一个stockplex组件，然后编辑组件属性对话框输入：

Stock Symbol: ADBE

Summary of Stock: Adobe's Stock
![img](/assets/articles/aem/lesson2/lesson10-8.jpg)
![img](/assets/articles/aem/lesson2/lesson10-9.jpg)
可以看到法语已经自动翻译了。
![img](/assets/articles/aem/lesson2/lesson10-10.jpg)

## 练习十一：快速添加国际化语种
### 方式一：
通过http://localhost:4502/libs/cq/i18n/translator.html可视化表格的方式，打开后过滤出自己的站点i18n,如：/apps/wetrain/i18n
![img](/assets/articles/aem/lesson2/lesson11-1.jpg)
双击其它语种后输入。如ES,示例中随便取的翻译，实际中请使用专业翻译。
![img](/assets/articles/aem/lesson2/lesson11-2.jpg)
回到CRXDE平台后，找到/apps/wetrain/i18n，可以看到自动生了一个es.json文件
![img](/assets/articles/aem/lesson2/lesson11-3.jpg)
利用代码工程的同步工具，将crxde同步到代码，然后编译安装即可。
![img](/assets/articles/aem/lesson2/lesson11-4.jpg)
![img](/assets/articles/aem/lesson2/lesson11-5.jpg)

### 方式二：
在开发代码工程里， copy一个.json的语种文件，重新命名翻译后，编译安装即可。


## 练习十二：（JAVA后端）使用sling Models 来实现业务逻辑
***步聚***：

1、打开开发代码工程，core目录下com.<your-project-name>.core.models对应的文件夹下创建一个Stockplex.java
```java
package com.wetrain.core.models;

import java.util.Map;

public class Stockplex {
    private String symbol;
    private String summary;
    private String showStockInfo;
    private Double currentPrice;
    private Map<String, Object> stockInfo;
    private String exportedType;
    private String data;

    public Stockplex(String symbol, String summary, String showStockInfo, Double currentPrice, Map<String, Object> stockInfo, String exportedType, String data) {
        this.symbol = symbol;
        this.summary = summary;
        this.showStockInfo = showStockInfo;
        this.currentPrice = currentPrice;
        this.stockInfo = stockInfo;
        this.exportedType = exportedType;
        this.data = data;
    }

    // Getters
    public String getSymbol() {
        return symbol;
    }

    public String getSummary() {
        return summary;
    }

    public String getShowStockInfo() {
        return showStockInfo;
    }

    public Double getCurrentPrice() {
        return currentPrice;
    }

    public Map<String, Object> getStockInfo() {
        return stockInfo;
    }

    public String getExportedType() {
        return exportedType;
    }

    public String getData() {
        return data;
    }
}
```
2、修改ui.apps下的stockplex组件中的stockplex.html,绑定到model上，内容如下：
通过 data-sly-use.stockplex="com.wetrain.core.models.Stockplex" 进行绑定到model,这里需要注意的就是JAVA的包名model所在的包路径一定要对。
```html
<div data-sly-use.stockplex="com.wetrain.core.models.Stockplex" 
    data-sly-use.template="core/wcm/components/commons/v1/templates.html" 
    data-sly-test.hasContent="${stockplex.symbol}" 
    class="cmp-stockplex">

    <div class="cmp-stockplex__column1">
        <div class="cmp-stockplex__symbol">${stockplex.symbol}</div>
        <div class="cmp-stockplex__currentPrice">${'Current Value:' @ i18n} ${stockplex.currentPrice}</div>

        <div class="cmp-stockplex__summary" data-sly-test.summary="${stockplex.summary}">
            <h3>${'Summary:' @ i18n} ${stockplex.summary}</h3>
        </div>

        <div class="cmp-stockplex__button">
            <a href="${currentPage.path @ selectors='model', extension='json'}">
                <button>${'Headless JSON View' @ i18n}</button>
            </a>
        </div>
    </div>
    <div class="cmp-stockplex__column2">
        <div class="cmp-stockplex__details" data-sly-test="${stockplex.showStockInfo}">
            <ul data-sly-list.sInfo="${stockplex.stockInfo}">
                <li class="cmp-stockplex__details-item">
                    <span class="cmp-stockplex__details-title">${sInfo @ i18n}:</span>
                    <br />
                    <span class="cmp-stockplex__details-value">${stockplex.stockInfo[sInfo]}</span>
                </li>
            </ul>
        </div>
    </div>
</div>

<!-- If there is no stock symbol added to the dialog, create a component placeholder -->
<sly data-sly-call="${template.placeholder @ isEmpty=!hasContent, classAppend='cmp-stockplex'}"></sly>
```
3、编译安装，打开一个stockplex组件所在的页面，查看此时组件显示的情况。如：
http://localhost:4502/editor.html/content/wetrain/us/en/helloworld.html
![img](/assets/articles/aem/lesson2/lesson12-1.jpg)
此时可见stockplex啥也看不到了，为什么？因为我们只是创建绑定了Java的model，但并没有让model读取之前通过属性对话框设置的值。所以现在model的所有属性值相当于null的。

4、如何读取jcr中存放的值呢？
通过CRXDE查看组件设置了那些值，如/content/wetrain/us/en/helloworld/jcr:content/root/container/container/stockplex
![img](/assets/articles/aem/lesson2/lesson12-2.jpg)
/conf/wetrain/settings/wcm/policies/wetrain/components/stockplex 查看组件策略设置的值
![img](/assets/articles/aem/lesson2/lesson12-3.jpg)

***使用JAVA注解的方式读取***

[关于模型注解查看官方文档](https://sling.apache.org/documentation/bundles/models.html)
修改Stockplex.java，注意被@Model 注解的java类，不要有自己的构造方法（有参或无参都不要有）

>这里注意：adaptables= SlingHttpServletRequest.class 如果改为adaptables= Resource.class,那么@ScriptVariable 就注解不到Style
{: .prompt-warning }

```java
package com.wetrain.core.models;

import com.day.cq.wcm.api.designer.Style;
import org.apache.sling.api.SlingHttpServletRequest;
import org.apache.sling.models.annotations.DefaultInjectionStrategy;
import org.apache.sling.models.annotations.Model;
import org.apache.sling.models.annotations.injectorspecific.ScriptVariable;
import org.apache.sling.models.annotations.injectorspecific.ValueMapValue;

import javax.annotation.PostConstruct;
import javax.inject.Inject;
import java.util.Map;

@Model(adaptables= SlingHttpServletRequest.class,
        defaultInjectionStrategy = DefaultInjectionStrategy.OPTIONAL)
public class Stockplex {
    @Inject
    private String symbol;
    // 等效于@Inject
    @ValueMapValue
    private String summary;
    private Boolean showStockInfo;
    private Double currentPrice;
    private Map<String, Object> stockInfo;
    private String exportedType;
    private String data;

    @ScriptVariable
    private Style currentStyle;

    @PostConstruct
    public  void init() {
      //读取design_dialog设置的策略数据
        String info = currentStyle.get("showStockInfo").toString();
        this.showStockInfo = info.equals("true");
    }

    // Getters
    public String getSymbol() {
        return symbol;
    }

    public String getSummary() {
        return summary;
    }

    public Boolean getShowStockInfo() {
        return showStockInfo;
    }

    public Double getCurrentPrice() {
        return currentPrice;
    }

    public Map<String, Object> getStockInfo() {
        return stockInfo;
    }

    public String getExportedType() {
        return exportedType;
    }

    public String getData() {
        return data;
    }
}
```
![img](/assets/articles/aem/lesson2/lesson12-4.jpg)
上面的代码虽然读出showStockInfo为true，但由于没有info信息，所以并不会显示detail信息。

5、stockplex 中的info数据，这里为了演示，从第三方网站获取，这里从adobe的github上
https://github.com/Adobe-Marketing-Cloud/ADLS-Samples/tree/master/stock-data
这里可以查看到有那些可以读取的数据。
![img](/assets/articles/aem/lesson2/lesson12-5.jpg)

如何通过get的方式读取某个json的数据呢？则使用：如读ADBE.json
https://raw.githubusercontent.com/Adobe-Marketing-Cloud/ADLS-Samples/master/stock-data/ADBE.json
<font color='red'>在stockplex.java中修改，并添加一个远程获取数据逻辑</font>
```java
....

@Model(adaptables= SlingHttpServletRequest.class,
        defaultInjectionStrategy = DefaultInjectionStrategy.OPTIONAL)
public class Stockplex {
    private static  final Logger logger = LoggerFactory.getLogger(Stockplex.class);
    @Inject
    private String symbol;
    //@Inject
    @ValueMapValue
    private String summary;
    private Boolean showStockInfo;
    private Double currentPrice;
    private Map<String, Object> stockInfo;
    private String exportedType;
    private String data;

    @ScriptVariable
    private Style currentStyle;

    @PostConstruct
    public  void init() {
        logger.debug("Stockplex init");
        //从三方接口获取数据
        remoteDataInitStockInfo();

        String info = currentStyle.get("showStockInfo").toString();
        this.showStockInfo = info.equals("true");
    }

    ....

    private void remoteDataInitStockInfo() {
        HttpClient httpClient = HttpClient.newHttpClient();
        String url = "https://raw.githubusercontent.com/Adobe-Marketing-Cloud/ADLS-Samples/master/stock-data/ADBE.json";
        HttpRequest request = HttpRequest.newBuilder()
                .uri(URI.create(url)) // 设置请求 URL
                .GET() // 使用 GET 方法
                .build();

        try {
            // 发送请求并获取响应（同步）
            HttpResponse<String> response = httpClient.send(request, HttpResponse.BodyHandlers.ofString());

            // 检查响应状态码
            if (response.statusCode() == 200) {
                // 获取响应体（json 内容）
                String jsonContent = response.body();
                Gson gson = new Gson();
                Type type = new TypeToken<Map<String, Object>>() {}.getType();
                Map<String, Object> map = gson.fromJson(jsonContent, type);
                this.stockInfo = map;

                this.currentPrice = 153.56;
                this.exportedType = "JSON";
                this.data = jsonContent;

                System.out.println("数据 (ADBE.json):\n" + jsonContent);
            } else {
                System.out.println("请求失败，状态码: " + response.statusCode());
            }
        } catch (IOException | InterruptedException e) {
            System.err.println("请求错误: " + e.getMessage());
        }
    }
}
```
最终效果：
![img](/assets/articles/aem/lesson2/lesson12-6.jpg)

<font color='red'>缺点</font>：
在init中调用远程接口并不是一个理想的实现，因为可能存在接口超时或异常情况，会导至model的页面加载过慢的情况。在后面的练习中将采用其它方案进行优化。

***附：github的创库数据有三种访问方式如：***

通过GitHub 的主网站，提供用户友好的网页界面，用于浏览、协作和管理代码仓库
https://github.com/Adobe-Marketing-Cloud/ADLS-Samples/tree/master/stock-data
原如数据访问的方式，提供 GitHub 仓库中文件的原始（Raw）内容，专注于直接访问文件数据，此方式必须直接到文件，如果是目录则返回404
https://raw.githubusercontent.com/Adobe-Marketing-Cloud/ADLS-Samples/master/stock-data/ADBE.json
采用API的方式，可支持 CRUD 操作：创建、读取、更新、删除仓库内容，管理 Issues、Actions 等
https://api.github.com/repos/Adobe-Marketing-Cloud/ADLS-Samples/contents/stock-data

## 练习十三：了解AEM Core框架的定时调度器的使用
在创建项目之时，脚手架就为我们在core/src/main/java/<package-name>/schedulers中创建了一个SimpleSeheduledTask
```java
/*
 *  Copyright 2015 Adobe Systems Incorporated
 *
 *  Licensed under the Apache License, Version 2.0 (the "License");
 *  you may not use this file except in compliance with the License.
 *  You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 *  Unless required by applicable law or agreed to in writing, software
 *  distributed under the License is distributed on an "AS IS" BASIS,
 *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *  See the License for the specific language governing permissions and
 *  limitations under the License.
 */
package com.wetrain.core.schedulers;

import org.osgi.service.component.annotations.Activate;
import org.osgi.service.component.annotations.Component;
import org.osgi.service.metatype.annotations.AttributeDefinition;
import org.osgi.service.metatype.annotations.Designate;
import org.osgi.service.metatype.annotations.ObjectClassDefinition;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

/**
 * A simple demo for cron-job like tasks that get executed regularly.
 * It also demonstrates how property values can be set. Users can
 * set the property values in /system/console/configMgr
 */
@Designate(ocd=SimpleScheduledTask.Config.class)
@Component(service=Runnable.class)
public class SimpleScheduledTask implements Runnable {

    @ObjectClassDefinition(name="A good scheduled task",
                           description = "Simple demo for cron-job like task with properties")
    public static @interface Config {

        @AttributeDefinition(name = "Cron-job expression")
        String scheduler_expression() default "*/30 * * * * ?";

        @AttributeDefinition(name = "Concurrent task",
                             description = "Whether or not to schedule this task concurrently")
        boolean scheduler_concurrent() default false;

        @AttributeDefinition(name = "A parameter",
                             description = "Can be configured in /system/console/configMgr")
        String myParameter() default "";
    }

    private final Logger logger = LoggerFactory.getLogger(getClass());

    private String myParameter;
    
    @Override
    public void run() {
        logger.debug("SimpleScheduledTask is now running, myParameter='{}'", myParameter);
    }

    @Activate
    protected void activate(final Config config) {
        myParameter = config.myParameter();
    }

}
```
定时调度器通过注解的方式让实例运行起来。
@Designate(ocd=SimpleScheduledTask.Config.class)
@Component(service=Runnable.class)
基中这个SimpleScheduledTask.Config.class 实例的配置项属性将会在AEM的/system/console/configMgr可视化操作界面中可实时配置。如打开：http://localhost:4502/system/console/configMgr

![img](/assets/articles/aem/lesson2/lesson13-1.jpg)

提供的样例定时cron表达式是每30秒执行一次run()方法。
如何实现多个定时调度器并存运行呢？

***步聚***：

1、可参考样例的调度器，快速创建一个。

2、添加配置属性来指定定时调度器名称，以防冲突String scheduler_name() default "DemoTask";

3、String scheduler_expression()，boolean scheduler_concurrent() 是固定必要的字段写法，不要随意改名，改了名，调度器就不会被执行了。

4、如果配置需要其它额名的参数时可以通过注解来实现在配置界面的说明
@AttributeDefinition(name = "xxx",description = "xx")
完整代码：

```java
package com.wetrain.core.schedulers;

import org.osgi.service.component.annotations.Activate;
import org.osgi.service.component.annotations.Component;
import org.osgi.service.component.annotations.Deactivate;
import org.osgi.service.metatype.annotations.AttributeDefinition;
import org.osgi.service.metatype.annotations.Designate;
import org.osgi.service.metatype.annotations.ObjectClassDefinition;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

@Designate(ocd = DemoScheduledTask.Config.class)
@Component(service=Runnable.class)
public class DemoScheduledTask implements Runnable {
    private final Logger logger = LoggerFactory.getLogger(getClass());

    @ObjectClassDefinition(name="调度任务示例",
            description = "配置定时调度属性")
    public static @interface Config {
        @AttributeDefinition(name = "cron表达式",
                description = "调度任务的cron表达式,每30秒执行一次")
        String scheduler_expression() default "*/30 * * * * ?";

        @AttributeDefinition(name = "并发任务",
                description = "是否并发执行任务,默认是false")
        boolean scheduler_concurrent() default false;

        //多个调度器时必须指定唯一的名称
        String scheduler_name() default "DemoTask";
    }

    @Override
    public void run() {
        logger.debug("DemoScheduledTask is running...");
    }

    @Activate
    protected void activate(final DemoScheduledTask.Config config) {
        logger.debug("DemoScheduledTask is activated...,config:{}", config);
    }

    @Deactivate
    protected void deactivate(final DemoScheduledTask.Config config) {
        logger.debug("DemoScheduledTask is deactivated...,config:{}", config);
    }
}
```
同样打开配置管理界面/system/console/configMgr。

![img](/assets/articles/aem/lesson2/lesson13-2.jpg)
![img](/assets/articles/aem/lesson2/lesson13-3.jpg)

5、确保定时器是否运行正常生效。
添加日志输出，查看日志的方式来判断。打开http://localhost:4502/system/console/slinglog
添加过滤输出Logger,然后直接到crx-quickstart里的logs文件下找对应的logfile查看即可。
![img](/assets/articles/aem/lesson2/lesson13-4.jpg)
![img](/assets/articles/aem/lesson2/lesson13-5.jpg)

## 练习十四：定时获取三方数据保存至JCR
知识点：
由于使用ResourceResolverFactory resourceResolverFactory; 对JCR进行访问，这个需要登录权限的，因此需要配置访问用户权限。

[官网服务用户访问说明](https://experienceleague.adobe.com/zh-hans/docs/experience-manager-learn/cloud-service/developing/advanced/service-users)

配置用户访问权限步聚：
1、打开代码工程ui.config/src/main/content/jcr_root/apps.<project-name>.osgiconfig/config，新建一个org.apache.sling.jcr.repoinit.RepositoryInitializer~stockplex.cfg.json，～前为固定写法，后为随便取的名称，后缀.cfg.json是固定的格式
```json
{
  "scripts": [
    "create service user weTrainUser\n set ACL on /content\n  allow jcr:all for weTrainUser\n end\n"
  ]
}
```
create service user weTrainUser :  创建用户weTrainUser
set ACL on /content : 设置访问/content目录的权限即（CRXDE上/content目录）          
allow jcr:all for weTrainUser ：授预允许weTrainUser访问/content 所有操作即jcr:all，如果只读则jcr:read
完全的执行脚本写法：

```shell
create service user weTrainUser
set ACL on /content
     allow jcr:all for weTrainUser
end
```
2、继续创建org.apache.sling.serviceusermapping.impl.ServiceUserMapperImpl.amended~stockplex.cfg.json
```json
{
  "service.ranking:Integer": 0,
  "user.mapping": "wetrain.core:training=weTrainUser"
}
```
注意这里wetrain.core:training 中的training，不太清楚是啥，可能是别名还是啥？没弄懂有了这个之后就可以通过
```java
Map<String, Object> serviceParams = new HashMap<>();
        serviceParams.put(ResourceResolverFactory.SUBSERVICE, "training");
ResourceResolver resourceResolver = resourceResolverFactory
                    .getServiceResourceResolver(serviceParams);
//只有用户权限对了才能有访问的实例，否则抛出登录异常
```
至此用户权限已配完成。

***使用定时器，定时从第三方获取数据***

***步聚***：

1、修改SimpleScheduledTask.java
```java
/*
 *  Copyright 2015 Adobe Systems Incorporated
 *
 *  Licensed under the Apache License, Version 2.0 (the "License");
 *  you may not use this file except in compliance with the License.
 *  You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 *  Unless required by applicable law or agreed to in writing, software
 *  distributed under the License is distributed on an "AS IS" BASIS,
 *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *  See the License for the specific language governing permissions and
 *  limitations under the License.
 */
package com.wetrain.core.schedulers;

import com.wetrain.core.schedulers.jobtasks.ReadStockImportJCRJobTask;
import org.osgi.service.component.annotations.Activate;
import org.osgi.service.component.annotations.Component;
import org.osgi.service.component.annotations.Reference;
import org.osgi.service.metatype.annotations.AttributeDefinition;
import org.osgi.service.metatype.annotations.Designate;
import org.osgi.service.metatype.annotations.ObjectClassDefinition;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

/**
 * A simple demo for cron-job like tasks that get executed regularly.
 * It also demonstrates how property values can be set. Users can
 * set the property values in /system/console/configMgr
 */
@Designate(ocd=SimpleScheduledTask.Config.class)
@Component(service=Runnable.class)
public class SimpleScheduledTask implements Runnable {
    @ObjectClassDefinition(name="A good scheduled task",
                           description = "Simple demo for cron-job like task with properties")
    public static @interface Config {

        @AttributeDefinition(name = "Cron-job expression")
        String scheduler_expression() default "0 */1 * * * ?";

        @AttributeDefinition(name = "Concurrent task",
                             description = "Whether or not to schedule this task concurrently")
        boolean scheduler_concurrent() default false;

        @AttributeDefinition(name = "A parameter",
                             description = "Can be configured in /system/console/configMgr")
        String myParameter() default "";

        String scheduler_name() default "SimpleScheduledTask";
    }

    private final Logger logger = LoggerFactory.getLogger(getClass());

    private String myParameter;

    
    @Reference
    private ReadStockImportJCRJobTask readStockImportJCRJobTask;

    @Override
    public void run() {
        logger.debug("SimpleScheduledTask is now running, myParameter='{}'", myParameter);
        try {
            readStockImportJCRJobTask.execute();
        } catch (Exception e) {
            logger.error("执行定时任务出错: {}", e.getMessage());
        }
    }

    @Activate
    protected void activate(final Config config) {
        myParameter = config.myParameter();
        logger.debug("SimpleScheduledTask is activated >>>>>>> config:{}", config);
    }

}

```
2、新增实现，在schedulers下新建文件夹jobtasks，然后新建一个ReadStockImportJCRJobTask.java文件。
![img](/assets/articles/aem/lesson2/lesson14-1.jpg)
```java
package com.wetrain.core.schedulers.jobtasks;

import com.day.cq.commons.jcr.JcrConstants;
import com.google.gson.Gson;
import com.google.gson.reflect.TypeToken;
import org.apache.sling.api.resource.*;
import org.osgi.service.component.annotations.Component;
import org.osgi.service.component.annotations.Reference;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import javax.jcr.RepositoryException;
import javax.net.ssl.HttpsURLConnection;
import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.lang.reflect.Type;
import java.net.URL;
import java.time.Instant;
import java.time.LocalDateTime;
import java.time.ZoneId;
import java.time.ZonedDateTime;
import java.time.format.DateTimeFormatter;
import java.util.HashMap;
import java.util.Map;

/**
 * 从远程接口导入数据到JCR任务
 * /content/stocks/
 *   + <STOCK_SYMBOL> [sling:OrderedFolder]
 *     + trade [nt:unstructured]
 *         	- companyName = <value>
 *       	- sector = <value>
 *           - lastTrade = <value>
 *           - timeOfUpdate = <value>
 *           - dayOfLastUpdate = <value>
 *           - openPrice = <value>
 *           - rangeHigh = <value>
 *           - rangeLow = <value>
 *           - volume = <value>
 *           - upDownPrice = <value>
 *           - week52High = <value>
 *           - week52Low = <value>
 *           - ytdChange = <value>
 */

@Component(service = ReadStockImportJCRJobTask.class, immediate = true)
public class ReadStockImportJCRJobTask {
    private static final Logger logger = LoggerFactory.getLogger(ReadStockImportJCRJobTask.class);
    private final String searchableLogStr = "【ImportJCR】";
    //"/content/stocks/symbol"
    public static final String STOCKJCRFOLDER = "/content/dam/wetrain/symbol";
    /// JCR资源解析工厂
    @Reference
    private ResourceResolverFactory resourceResolverFactory;

//    public ReadStockImportJCRJobTask() {}
    public void execute() throws Exception {
        String remoteUrl = "https://raw.githubusercontent.com/Adobe-Marketing-Cloud/ADLS-Samples/master/stock-data/";
        String symbol = "ADBE.json";
        String stockUrl = remoteUrl + symbol;
        logger.debug("开始执行定时任务: 读取远程[{}]数据.....",stockUrl);
        HttpsURLConnection request = null;
        try {
            URL sourceUrl = new URL(stockUrl);
            request = (HttpsURLConnection) sourceUrl.openConnection();
            request.setConnectTimeout(5000);
            request.setReadTimeout(10000);
            request.connect();
//            request.setRequestMethod(HttpConstants.METHOD_GET);
            try {
                InputStream inputStream = request.getInputStream();
                BufferedReader reader = new BufferedReader(new InputStreamReader(inputStream));
                StringBuilder response = new StringBuilder();
                String line;
                while ((line = reader.readLine()) != null) {
                    response.append(line);
                }
                String result = response.toString();
                Gson gson = new Gson();
                Type type = new TypeToken<Map<String, Object>>() {}.getType();
                Map<String, Object> stockJsonInfo = gson.fromJson(result, type);
                writeToJCRepository(stockJsonInfo);
            } catch (IOException e) {
                throw new RuntimeException(e);
            }
        }
        catch (IOException e) {
            logger.error(searchableLogStr + "The stock symbol: {}",e.getMessage());
        } finally {
            if (request != null) {
                request.disconnect(); // 关闭连接
            }
        }
    }

    private void writeToJCRepository(Map<String, Object> allQuoteData) throws RepositoryException {
        logger.debug("响应的jsonData: {} ", allQuoteData);
        Map<String, Object> serviceParams = new HashMap<>();
        serviceParams.put(ResourceResolverFactory.SUBSERVICE, "training");
        try {
            ResourceResolver resourceResolver = resourceResolverFactory
                    .getServiceResourceResolver(serviceParams);
            logger.debug("获取ResourceResolver成功: {}", resourceResolver);
            ///获取最后更新时间
            Long latestUpdateTime = allQuoteData.get("latestUpdate") != null ?
                    ((Double) allQuoteData.get("latestUpdate")).longValue() : 0L;
            ZoneId timeZone = ZoneId.of("America/New_York");
            LocalDateTime timePerLatestUpdate = LocalDateTime.ofInstant(Instant.ofEpochMilli(latestUpdateTime),
                    timeZone);
            ZonedDateTime timeWithZone = ZonedDateTime.of(timePerLatestUpdate, timeZone);
            DateTimeFormatter timeFormatter = DateTimeFormatter.ofPattern("hh:mm a zz");
            String UpdateTimeOfDay = timeWithZone.format(timeFormatter);
            DateTimeFormatter dayFormatter = DateTimeFormatter.ofPattern("E MMMM d, yyyy");
            String dayOfUpdate = timeWithZone.format(dayFormatter);

            String stockPath =  STOCKJCRFOLDER;
            String tradePath = stockPath + "/trade";
            Resource trade = resourceResolver.getResource(tradePath);

            // 如果/content/stocks/symbol不存在，则创建
            Resource stockFolder = ResourceUtil.getOrCreateResource(resourceResolver, stockPath, "", "", false);
            if (trade == null) {
                // 创建trade节点
                Map<String, Object> tradeNode = new HashMap<>();
                tradeNode.put(JcrConstants.JCR_PRIMARYTYPE, JcrConstants.NT_UNSTRUCTURED);
                trade = resourceResolver.create(stockFolder, "trade", tradeNode);
                logger.debug("Created new trade node: {}", trade.getPath());
            }

            ModifiableValueMap stockData = trade.adaptTo(ModifiableValueMap.class);
            if (stockData == null) {
                logger.error("无法适配 ModifiableValueMap for resource: {}", trade.getPath());
                return;
            }

            String cp = getValueSafely(allQuoteData,"companyName",String.class);
            String sector = getValueSafely(allQuoteData,"sector",String.class);
            Double lastPrice = getValueSafely(allQuoteData,"latestPrice", Double.class);
            Double high = getValueSafely(allQuoteData,"high", Double.class);
            Double low = getValueSafely(allQuoteData,"low", Double.class);
            Double open = getValueSafely(allQuoteData,"open", Double.class);
            Double latestVolume = getValueSafely(allQuoteData,"latestVolume", Double.class);
            Double change = getValueSafely(allQuoteData,"change", Double.class);
            Double week52High = getValueSafely(allQuoteData,"week52High", Double.class);
            Double week52Low = getValueSafely(allQuoteData,"week52Low", Double.class);
            Double ytdChange = getValueSafely(allQuoteData,"ytdChange", Double.class);


            stockData.put("companyName", cp);
            stockData.put("sector", sector);
            stockData.put("timeOfUpdate", UpdateTimeOfDay);
            stockData.put("dayOfLastUpdate", dayOfUpdate);
            stockData.put("lastTrade", lastPrice);
            stockData.put("openPrice", open);
            stockData.put("rangeHigh", high);
            stockData.put("rangeLow", low);
            stockData.put("volume", latestVolume);
            stockData.put("upDown",change );
            stockData.put("week52High",week52High);
            stockData.put("week52Low",week52Low);
            stockData.put("ytdPercentageChange",ytdChange);

            logger.debug("最新数据更新时间: {}, 日期: {}", UpdateTimeOfDay, dayOfUpdate);
            logger.debug("准备保存的股票数据: {}", stockData);
            //保存到JCR
            resourceResolver.commit();
            logger.info(searchableLogStr + "股票数据已成功保存到JCR: {}", stockData);
            resourceResolver.close();
            logger.debug("ResourceResolver已关闭");
        } catch (LoginException | PersistenceException e) {
            logger.error("获取ResourceResolver失败: {}", e.getMessage());
        }
    }

    public static <T> T getValueSafely(Map<String, Object> map, String key, Class<T> type) {
        Object value = map.get(key);
        if (value == null) {
            return null;
        }
        if (type.isInstance(value)) {
            return type.cast(value);
        }
        throw new ClassCastException("Value for key '" + key + "' is not of type " + type.getSimpleName());
    }
}

```
3、编译安装后，在CRXDE中/content/dam/wetrain/symbol 找到trade结点查看导入的数据。
![img](/assets/articles/aem/lesson2/lesson14-2.jpg)
4、修改model来读取存在JCR中的内容
Stockplex.java
```java
package com.wetrain.core.models;

import com.day.cq.wcm.api.Page;
import com.day.cq.wcm.api.designer.Style;
import com.google.gson.Gson;
import com.wetrain.core.schedulers.jobtasks.ReadStockImportJCRJobTask;
import org.apache.sling.api.SlingHttpServletRequest;
import org.apache.sling.api.resource.Resource;
import org.apache.sling.api.resource.ValueMap;
import org.apache.sling.models.annotations.DefaultInjectionStrategy;
import org.apache.sling.models.annotations.Model;
import org.apache.sling.models.annotations.injectorspecific.ResourcePath;
import org.apache.sling.models.annotations.injectorspecific.ScriptVariable;
import org.apache.sling.models.annotations.injectorspecific.ValueMapValue;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import javax.annotation.PostConstruct;
import javax.inject.Inject;
import java.util.HashMap;
import java.util.Map;

@Model(adaptables= SlingHttpServletRequest.class,
        defaultInjectionStrategy = DefaultInjectionStrategy.OPTIONAL)
public class Stockplex {
    private static  final Logger logger = LoggerFactory.getLogger(Stockplex.class);
    @Inject
    private String symbol;
    //@Inject
    @ValueMapValue
    private String summary;
    private Boolean showStockInfo;
    private Double currentPrice;
    private Map<String, Object> stockInfo;
    private String exportedType;
    private String data;

    //HTL 全局对象
    @ScriptVariable
    private Style currentStyle;
    @ScriptVariable
    private Page currentPage;

    //指定路径注入对应路径的资源eg:/content/dam/wetrain/symbol
    @ResourcePath(path = ReadStockImportJCRJobTask.STOCKJCRFOLDER)
    private Resource stocksRoot;

    @PostConstruct
    public  void init() {
        logger.debug("Stockplex init");
        /// 读取design_dialog中的属性
        Object hasShow = currentStyle.get("showStockInfo");
        if (hasShow != null) {
            String info = hasShow.toString();
            this.showStockInfo = info.equals("true");
        }
        this.exportedType = "JSON";

        ValueMap tradeValues = null;
        if (stocksRoot != null) {
            ///content/dam/wetrain/symbol/trade
            Resource lastTradeResource = stocksRoot.getChild("trade");
            if(lastTradeResource != null){
                tradeValues = lastTradeResource.getValueMap();
            }
        }

        this.stockInfo = new HashMap<>();
        if (tradeValues != null) {
            this.currentPrice = tradeValues.get("lastTrade", Double.class);
            this.stockInfo.put("companyName", tradeValues.get("companyName", String.class));
            this.stockInfo.put("sector", tradeValues.get("sector", String.class));
            this.stockInfo.put("lastTrade", tradeValues.get("lastTrade", Double.class));
            this.stockInfo.put("timeOfUpdate", tradeValues.get("timeOfUpdate", String.class));
            this.stockInfo.put("dayOfLastUpdate", tradeValues.get("dayOfLastUpdate", String.class));
            this.stockInfo.put("openPrice", tradeValues.get("openPrice", Double.class));
            this.stockInfo.put("rangeHigh", tradeValues.get("rangeHigh", Double.class));
            this.stockInfo.put("rangeLow", tradeValues.get("rangeLow", Double.class));
            this.stockInfo.put("volume", tradeValues.get("volume", Long.class));
            this.stockInfo.put("upDownPrice", tradeValues.get("upDownPrice", Double.class));
            this.stockInfo.put("week52High", tradeValues.get("week52High", Double.class));
            this.stockInfo.put("week52Low", tradeValues.get("week52Low", Double.class));
            this.stockInfo.put("ytdChange", tradeValues.get("ytdChange", Double.class));
        } else {
            this.currentPrice = 0.0;
        }
        Map<String, Object> stockplexProperties = new HashMap<>();
        stockplexProperties.put("symbol", this.getSymbol());
        stockplexProperties.put("summary", this.getSummary());
        stockplexProperties.put("showStockInfo", this.getShowStockInfo());
        stockplexProperties.put("currentPrice", this.getCurrentPrice());
        stockplexProperties.put("stockInfo", this.getStockInfo());

        Gson gson = new Gson();
        this.data = gson.toJson(stockplexProperties);
    }

    // Getters
    public String getSymbol() {
        return symbol;
    }

    public String getSummary() {
        return summary;
    }

    public Boolean getShowStockInfo() {
        return showStockInfo;
    }

    public Double getCurrentPrice() {
        return currentPrice;
    }

    public Map<String, Object> getStockInfo() {
        return stockInfo;
    }

    public String getExportedType() {
        return exportedType;
    }

    public String getData() {
        return data;
    }

}
```
5、修改stockplex.html
```html
<div data-sly-use.stockplex="com.wetrain.core.models.Stockplex"
     data-sly-use.template="core/wcm/components/commons/v1/templates.html"
     data-sly-test.hasContent="${stockplex.symbol}"
     class="cmp-stockplex">

    <div class="cmp-stockplex__column1">
        <div class="cmp-stockplex__symbol">${stockplex.symbol}</div>
        <div class="cmp-stockplex__currentPrice">${'Current Value:' @ i18n} ${stockplex.currentPrice}</div>

        <div class="cmp-stockplex__summary" data-sly-test.summary="${stockplex.summary}">
            <h3>${'Summary:' @ i18n} ${stockplex.summary}</h3>
        </div>

        <div class="cmp-stockplex__button">
            <a href="${currentPage.path @ selectors='model', extension='json'}">
                <button>${'Headless JSON View' @ i18n}</button>
            </a>
        </div>
    </div>
    <div class="cmp-stockplex__column2">
        <div class="cmp-stockplex__details" data-sly-test="${stockplex.showStockInfo}">
            <ul data-sly-list.sInfo="${stockplex.stockInfo}">
                <li class="cmp-stockplex__details-item">
                    <span class="cmp-stockplex__details-title">${sInfo @ i18n}:</span>
                    <br />
                    <span class="cmp-stockplex__details-value">${stockplex.stockInfo[sInfo]}</span>
                </li>
            </ul>
        </div>
    </div>
</div>

<!-- If there is no stock symbol added to the dialog, create a component placeholder -->
<sly data-sly-call="${template.placeholder @ isEmpty=!hasContent, classAppend='cmp-stockplex'}"></sly>

```
点击组件在属性对话框输入。在显示详情时，在Edit Template 里的policy下把showStockInfo勾上。
![img](/assets/articles/aem/lesson2/lesson14-3.jpg)

## 练习十五：提供servlet接口，可作headless使用
步聚：
1、打开代码工程，在core项目下的servlet新建一个StockplexFetchServlet.java文件，内容如下： 
```java
package com.wetrain.core.servlets;

import com.day.cq.search.PredicateGroup;
import com.day.cq.search.Query;
import com.day.cq.search.QueryBuilder;
import com.day.cq.search.result.Hit;
import com.day.cq.search.result.SearchResult;
import com.drew.lang.annotations.NotNull;
import com.google.gson.Gson;
import com.wetrain.core.models.Stockplex;
import org.apache.sling.api.SlingHttpServletRequest;
import org.apache.sling.api.SlingHttpServletResponse;
import org.apache.sling.api.resource.Resource;
import org.apache.sling.api.resource.ResourceResolver;
import org.apache.sling.api.resource.ValueMap;
import org.apache.sling.api.servlets.HttpConstants;
import org.apache.sling.api.servlets.SlingAllMethodsServlet;
import org.apache.sling.servlets.annotations.SlingServletResourceTypes;
import org.osgi.service.component.annotations.Component;
import org.osgi.service.component.propertytypes.ServiceDescription;

import javax.jcr.Session;
import javax.servlet.Servlet;
import javax.servlet.ServletException;
import java.io.IOException;
import java.util.HashMap;
import java.util.Map;

@Component(service = { Servlet.class })
@SlingServletResourceTypes(
        resourceTypes="wetrain/components/page",
        selectors = "fetch_stock",
        methods= HttpConstants.METHOD_GET,
        extensions="json")
@ServiceDescription("Fetch Stockplex Servlet")
public class StockplexFetchServlet extends SlingAllMethodsServlet {
    @Override
    protected void doGet(@NotNull SlingHttpServletRequest request, @NotNull SlingHttpServletResponse response) throws ServletException, IOException {
        response.setContentType("application/json");
//        readFromJCR(request, response);
        realFromHtmlBindNode(request, response);
    }

    private static void realFromHtmlBindNode(SlingHttpServletRequest request, SlingHttpServletResponse response) {
        Resource stockplexResource = request.getResource();
        ResourceResolver resolver = stockplexResource.getResourceResolver();
        Session session = resolver.adaptTo(Session.class);
        QueryBuilder queryBuilder = resolver.adaptTo(QueryBuilder.class);

        if (session == null || queryBuilder == null) {
            throw new IllegalStateException("Could not adapt to Session or QueryBuilder");
        }

        Map<String, String> predicate = new HashMap<>();
        predicate.put("path", "/content/wetrain/us/en/helloworld/jcr:content/root/container/container");
        Query query = queryBuilder.createQuery(PredicateGroup.create(predicate), session);
        SearchResult result = query.getResult();

        Hit hit = result.getHits().get(0); //用getFrist()会报错

//        result.getHits().forEach(hit -> {
//
//        });

        try {
            Resource res = hit.getResource();
            Stockplex stockplex = res.adaptTo(Stockplex.class);
            if (stockplex != null) {
                response.getWriter().write(stockplex.getData());
            }
        } catch (Exception e) {

        }
    }

    private void readFromJCR(SlingHttpServletRequest request, SlingHttpServletResponse response) throws IOException {
        Resource stockplexResource = request.getResource();
        ResourceResolver resolver = stockplexResource.getResourceResolver();
        Resource stockplexInfo = resolver.getResource("/content/dam/wetrain/symbol/trade");
        ValueMap v_map = stockplexInfo.getValueMap();

        Map<String, Object> stockplexProperties = new HashMap<>();
        stockplexProperties.put("@type", request.getResource().getResourceType());
        stockplexProperties.put("stockInfo", v_map);
        Gson gson = new Gson();
        String json_str = gson.toJson(stockplexProperties);
        response.getWriter().write(json_str);
    }


}
```
2、修改一下models文件夹下的Stockplex.java
```java
package com.wetrain.core.models;

import com.day.cq.wcm.api.Page;
import com.day.cq.wcm.api.designer.Style;
import com.google.gson.Gson;
import com.wetrain.core.schedulers.jobtasks.ReadStockImportJCRJobTask;
import org.apache.sling.api.SlingHttpServletRequest;
import org.apache.sling.api.resource.Resource;
import org.apache.sling.api.resource.ValueMap;
import org.apache.sling.models.annotations.DefaultInjectionStrategy;
import org.apache.sling.models.annotations.Model;
import org.apache.sling.models.annotations.injectorspecific.*;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import javax.annotation.PostConstruct;
import javax.inject.Inject;
import java.util.HashMap;
import java.util.Map;

@Model(adaptables= {SlingHttpServletRequest.class, Resource.class},
        defaultInjectionStrategy = DefaultInjectionStrategy.OPTIONAL)
public class Stockplex {
    private static  final Logger logger = LoggerFactory.getLogger(Stockplex.class);
    @Inject
    private String symbol;
    @ValueMapValue
    private String summary;
    private Boolean showStockInfo;
    private Double currentPrice;
    private Map<String, Object> stockInfo;
    private String exportedType;
    private String data;

    /// ----此处声明的注入必须Model配置adaptables=SlingHttpServletRequest.class才能注入-----
    //HTL 全局对象
    @ScriptVariable
    private Style currentStyle;
    @ScriptVariable
    private Page currentPage;
    @ScriptVariable
    private SlingHttpServletRequest request;
    /// -------------------------------------------------------------------------------

    //指定路径注入对应路径的资源eg:/content/dam/wetrain/symbol
    @ResourcePath(path = ReadStockImportJCRJobTask.STOCKJCRFOLDER)
    private Resource stocksRoot;

    @Self
    private Resource currentResource;

    @PostConstruct
    public  void init() {
        logger.debug("Stockplex init");

        //当不是来自SlingHttpServletRequest时 currentPage为null
        if (currentPage != null) {
            /// 读取design_dialog中的属性
            Object hasShow = currentStyle.get("showStockInfo");
            if (hasShow != null) {
                String info = hasShow.toString();
                this.showStockInfo = info.equals("true");
            }
        }

        this.exportedType = "JSON";

        ValueMap tradeValues = null;
        if (stocksRoot != null) {
            ///content/dam/wetrain/symbol/trade
            Resource lastTradeResource = stocksRoot.getChild("trade");
            if(lastTradeResource != null){
                tradeValues = lastTradeResource.getValueMap();
            }
        }

        this.stockInfo = new HashMap<>();
        if (tradeValues != null) {
            this.currentPrice = tradeValues.get("lastTrade", Double.class);
            this.stockInfo.put("companyName", tradeValues.get("companyName", String.class));
            this.stockInfo.put("sector", tradeValues.get("sector", String.class));
            this.stockInfo.put("lastTrade", tradeValues.get("lastTrade", Double.class));
            this.stockInfo.put("timeOfUpdate", tradeValues.get("timeOfUpdate", String.class));
            this.stockInfo.put("dayOfLastUpdate", tradeValues.get("dayOfLastUpdate", String.class));
            this.stockInfo.put("openPrice", tradeValues.get("openPrice", Double.class));
            this.stockInfo.put("rangeHigh", tradeValues.get("rangeHigh", Double.class));
            this.stockInfo.put("rangeLow", tradeValues.get("rangeLow", Double.class));
            this.stockInfo.put("volume", tradeValues.get("volume", Long.class));
            this.stockInfo.put("upDownPrice", tradeValues.get("upDownPrice", Double.class));
            this.stockInfo.put("week52High", tradeValues.get("week52High", Double.class));
            this.stockInfo.put("week52Low", tradeValues.get("week52Low", Double.class));
            this.stockInfo.put("ytdChange", tradeValues.get("ytdChange", Double.class));
        } else {
            this.currentPrice = 0.0;
        }
        Map<String, Object> stockplexProperties = new HashMap<>();
        stockplexProperties.put("symbol", this.getSymbol());
        stockplexProperties.put("summary", this.getSummary());
        stockplexProperties.put("showStockInfo", this.getShowStockInfo());
        stockplexProperties.put("currentPrice", this.getCurrentPrice());
        stockplexProperties.put("stockInfo", this.getStockInfo());

        Gson gson = new Gson();
        this.data = gson.toJson(stockplexProperties);
    }

    // Getters
    public String getSymbol() {
        return symbol;
    }

    public String getSummary() {
        return summary;
    }

    public Boolean getShowStockInfo() {
        return showStockInfo;
    }

    public Double getCurrentPrice() {
        return currentPrice;
    }

    public Map<String, Object> getStockInfo() {
        return stockInfo;
    }

    public String getExportedType() {
        return exportedType;
    }

    public String getData() {
        return data;
    }

}
```
3、分别任选其一打开StockplexFetchServlet.java中的，代码进行测试输出的效果。
```java
//        readFromJCR(request, response);
        realFromHtmlBindNode(request, response);
```
4、在浏览中输入http://localhost:4502/content/wetrain/us/en/helloworld/jcr:content.fetch_stock.json
realFromHtmlBindNode的效果为：
![img](/assets/articles/aem/lesson2/lesson15-1.jpg)
readFromJCR的效果为：
![img](/assets/articles/aem/lesson2/lesson15-2.jpg)

## Model注解知识点注意事项
以下面的model为例说明：
```java
package com.wetrain.core.models;
...
@Model(adaptables= {SlingHttpServletRequest.class, Resource.class},
        defaultInjectionStrategy = DefaultInjectionStrategy.OPTIONAL)
public class Stockplex {
    ...
    /// ----此处声明的注入必须Model配置adaptables=SlingHttpServletRequest.class才能注入-----
    //HTL 全局对象
    @ScriptVariable
    private Style currentStyle;
    @ScriptVariable
    private Page currentPage;
    @ScriptVariable
    private SlingHttpServletRequest request;
    /// -------------------------------------------------------------------------------
    ...
    @Self
    private Resource currentResource;

    @PostConstruct
    public  void init() {
        ...
    }

    // Getters
    ...

}
```
知识点一：

@Model注解

@Model(adaptables= {SlingHttpServletRequest.class, Resource.class})和只用Model(adaptables= Resource.class)
两者的区别：
当只使用Resource时，HTL的全局对象是不会被注入的。即代码上使用

@ScriptVariable注解的都不会被注入实例对象。
使用网页调试：http://localhost:4502/editor.html/content/wetrain/us/en/helloworld.html
![img](/assets/articles/aem/lesson2/model-1.jpg)
当同时支持SlingHttpServletRequest.class时可以成功注入。因为HTL的全局对象都是来自SlingHttpServletRequest的实例
![img](/assets/articles/aem/lesson2/model-2.jpg)

因此在设计Model 时非必要不直接绑定HTL全局对象，而把全局对象，直接在给件的.html中使用即可。
如：stockplex.html
直接使用HTL 全局对象访问<font color='red'>${currentStyle.showStockInfo}"</font>
```html
<div data-sly-use.stockplex="com.wetrain.core.models.Stockplex"
     data-sly-use.template="core/wcm/components/commons/v1/templates.html"
     data-sly-test.hasContent="${stockplex.symbol}"
     class="cmp-stockplex">

    ...
    <div class="cmp-stockplex__column2">
        <div class="cmp-stockplex__details" data-sly-test="${currentStyle.showStockInfo}">
            ...
        </div>
    </div>
</div>

....

```
也可以使用model的属性<font color='red'>${stockplex.showStockInfo}</font>，但这样就要求model必须注入currentStyle了。
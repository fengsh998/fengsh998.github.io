---
layout: post
title: "AEM开发系列-HTL语法规范简篇(七)"
categories: AEM开发系列
tags: AEM
author: fengsh998
typora-root-url: ..
---

# 语法、语义说明：
## 一、规则说明。

```shell
expression = '${' , [exprNode] , [ , '@' , optionList] , '}' ;

optionList = option {',' , option} ;

option = id [ , '=' , optionValues] ; 

optionValues = exprNode
             | '[' , valueList , ']' ;

valueList = exprNode {',' exprNode} ;

exprNode = orBinaryOp , '?' , orBinaryOp , ws , ':' , ws , orBinaryOp
         | orBinaryOp ;

orBinaryOp = andBinaryOp {, '||', andBinaryOp};

andBinaryOp = inBinaryOp {, '&&', inBinaryOp};

inBinaryOp = comparisonOp [, 'in', comparisonOp];

comparisonOp = factor [, comparisonOperator, factor];

comparisonOperator = '<'
     | '<='
     | '=='
     | '>='
     | '>'
     | '!=' ;

factor = term
       | '!' , term ;

term = propertyAccess
     | '(' , exprNode  , ')'
     | '[', valueList, ']' ;

/* Note the 'comma rule' means zero or more whitespace characters. Used to indicate optional whitespace around terminals above */
, = {ws} ;

ws = ' '
   | '\t'
   | '\r'
   | '\n'
   | '\u000B'
   | '\u00A0';

/* Note that unlike terminals above, the field access character '.' cannot have optional whitespace around it */
propertyAccess = atom {'.' id}
               | atom {'[' , exprNode , ']'};

atom = string
     | id
     | int
     | float
     | bool ;

bool = 'true'
     | 'false' ;

id = ('a'..'z'|'A'..'Z'|'_') {'a'..'z'|'A'..'Z'|'0'..'9'|'_'|':'} ;

int = ['-']('1'..'9'){'0'..'9'}
    | '0' ;

float = ['-']('1'..'9'){'0'..'9'} '.' {'0'..'9'} [exponent]
      | ['-']'0.' ('0'..'9') {'0'..'9'} [exponent]
      | ['-']('1'..'9'){'0'..'9'} exponent ;

/* An HTL comment can contain any character sequence other than '*/-->' */
comment = '<!--/*' {-('*/-->')} '*/-->' ;

/* A string can be delimited by either double or single quotes. Within these delimiters it may contain either escape sequences or any characters other than backslash and whichever quote was used for delimiting. */
string = '"' {escSeq | -('\\' | '"')} '"'
       | '\'' {escSeq | -('\\'|'\'')} '\'' ;

exponent = ('e'|'E') ['+'|'-'] ('0'..'9'){'0'..'9'} ;

escSeq = '\\' ('b'|'t'|'n'|'f'|'r'|'\"'|'\''|'\\')
       | unicodeEsc;

unicodeEsc = '\\' 'u' hexDigit hexDigit hexDigit hexDigit ;

hexDigit = ('0'..'9'|'a'..'f'|'A'..'F') ;
```
__核心规则总结__
1. __表达式 (expression)__：所有动态内容通过 <span style="color:#FF5733;">${}</span> 封装，支持 <span style="color:#FF5733;">exprNode</span>（表达式节点）和可选的 <span style="color:#FF5733;">optionList</span>（如 @ format='uppercase'）。
2. __逻辑运算__：支持三元表达式 (<span style="color:#FF5733;">?:</span>)、逻辑或 (<span style="color:#FF5733;">||</span>)、逻辑与 (<span style="color:#FF5733;">&&</span>)、包含 (<span style="color:#FF5733;">in</span>) 和比较操作 <span style="color:#FF5733;">(<, <=, ==, >=, >, !=)</span>。
3. __属性访问__：通过点号 (<span style="color:#FF5733;">.</span>) 或方括号 (<span style="color:#FF5733;">[]</span>) 访问对象属性或数组元素，如 <span style="color:#FF5733;">${user.name} 或 ${items[0]}</span>。
4. __选项列表__：通过 <span style="color:#FF5733;">@ </span>定义选项，如<span style="color:#FF5733;"> @ format='uppercase' </span>或<span style="color:#FF5733;"> @ items=[1, 2, 3]</span>，支持复杂配置。
5. __数据类型__：支持字符串 (<span style="color:#FF5733;">string</span>)、标识符 (<span style="color:#FF5733;">id</span>)、整数 (<span style="color:#FF5733;">int</span>)、浮点数 (<span style="color:#FF5733;">float</span>)、布尔值 (<span style="color:#FF5733;">bool</span>)，以及 Unicode 转义。
6. __注释__：使用 <!--/* ... */--> 格式，便于代码维护。

__实例说明：__
```html
 // 使用 || 提供默认值 'Guest'，当 properties.userName 为空时显示默认值
${properties.userName || 'Guest'}

//条件渲染
<div class="${user.isActive ? 'active' : 'inactive'}">
  ${user.isActive ? 'Welcome back!' : 'Please log in'}
</div>

//列表渲染 结合 AEM 的 data-sly-list 和 HTL 选项 @ format='uppercase'，将数组 properties.items 渲染为大写列表项。适用于动态生成菜单、产品列表等
<ul data-sly-list.item="${properties.items}">
  <li>${item @ format='uppercase'}</li>
</ul>

// 属性访问与嵌套
<p>Name: ${user.profile.name}</p>
<p>Address: ${user.profile.address[0].street}</p>

//格式化与国际化 使用 @ format 指定日期格式，@ i18n 启用国际化支持，适用于多语言网站或动态日期显示。
${properties.date @ format='yyyy-MM-dd', i18n}

//根据条件过滤和显示数据
${properties.score > 10 && properties.status in ['active', 'pending'] ? properties.title : 'Default Title'}


// 处理转议
${"Hello \"World\"!\nWelcome to HTL" @ context='text'}

```
### 1. expression 规则
__规则定义:__

<span style="color:#FF5733;">expression = '${' , [exprNode] , [ , '@' , optionList] , '}' ;</span>

__说明:__

expression 是 HTL 的核心表达式，包含在 ${} 中，可能包含一个 exprNode（表达式节点）和可选的 @ 后跟 optionList（选项列表）。exprNode 和 optionList 都是可选的。

__示例:__

1. 简单表达式，只有 exprNode:
<div style="background-color:#fafad2;padding:10px;border-radius:5px;">
  ${title}
</div>

***说明：***

仅包含一个标识符 title 作为 exprNode，没有选项列表。

2. 带选项的表达式:
<div style="background-color:#fafad2;padding:10px;border-radius:5px;">
  ${title @ <span style="color:#FF5733;">format</span>=<span style="color:#228B22;">'uppercase'</span>}
</div>

***说明：***

title 是 exprNode，@ format='uppercase' 是 optionList。

3. 空表达式:
<div style="background-color:#fafad2;padding:10px;border-radius:5px;">
  ${}
</div>

***说明：***

exprNode 和 optionList 都省略，仅有 ${}。

### 2. optionList 规则
__规则定义:__

<span style="color:#FF5733;">optionList = option {',' , option} ;</span>

__说明:__

<span style="color:#FF5733;">optionList</span> 是一个或多个 <span style="color:#FF5733;">option</span>，选项之间用逗号分隔，逗号周围可以有零个或多个空白字符。

__示例:__

1. 单个选项:

<div style="background-color:#fafad2;padding:10px;border-radius:5px;">
  @ format='uppercase'
</div>

__说明:__

只有一个 <span style="color:#FF5733;">option</span>，即 <span style="color:#FF5733;">format='uppercase'</span>。

2. 多个选项:

<div style="background-color:#fafad2;padding:10px;border-radius:5px;">
  @ format='uppercase', join=' - '
</div>

__说明：__

包含两个 <span style="color:#FF5733;">option</span>，分别是 <span style="color:#FF5733;">format='uppercase' 和 join=' - '</span>，逗号分隔。

3. 带空白的多个选项:

<div style="background-color:#fafad2;padding:10px;border-radius:5px;">
  @ format='uppercase'  , join=' - '
</div>

__说明：__

逗号前后有空白字符，符合 , 规则。

### 3. option 规则
__规则定义:__
<span style="color:#FF5733;">option = id [ , '=' , optionValues] ;</span>

__说明:__

<span style="color:#FF5733;">option</span> 由一个标识符 <span style="color:#FF5733;">id</span> 组成，后面可以选择性地跟一个 = 和 <span style="color:#FF5733;">optionValues</span>（选项值）。

__示例:__

1. 只有标识符的选项:

<div style="background-color:#fafad2;padding:10px;border-radius:5px;">
  @ i18n
</div>

***说明：***

仅包含标识符 <span style="color:#FF5733;">i18n</span>，没有 <span style="color:#FF5733;">optionValues</span>。

2. 带值的选项:

<div style="background-color:#fafad2;padding:10px;border-radius:5px;">
  @ format='uppercase'
</div>

***说明：***

<span style="color:#FF5733;">format</span> 是<span style="color:#FF5733;"> id，'uppercase' </span>是 <span style="color:#FF5733;">optionValues</span>。

3. 带数组值的选项:

<div style="background-color:#fafad2;padding:10px;border-radius:5px;">
  @ items=[1, 2, 3]
</div>

***说明：***

<span style="color:#FF5733;">items</span> 是 <span style="color:#FF5733;">id，[1, 2, 3] </span>是 <span style="color:#FF5733;">optionValues</span>（数组形式）。

### 4. optionValues 规则
__规则定义:__

<span style="color:#FF5733;">optionValues = exprNode | '[' , valueList , ']' ;</span>

__说明:__

<span style="color:#FF5733;">optionValues</span> 可以是一个 <span style="color:#FF5733;">exprNode</span>（表达式节点）或一个用方括号包裹的 <span style="color:#FF5733;">valueList</span>（值列表）。

__示例:__

1. 单值（exprNode）:

<div style="background-color:#fafad2;padding:10px;border-radius:5px;">
  @ format='uppercase'
</div>

***说明：***

<span style="color:#FF5733;">'uppercase' </span>是一个 <span style="color:#FF5733;">exprNode</span>（这里是一个 string）。

2. 数组值（valueList）:

<div style="background-color:#fafad2;padding:10px;border-radius:5px;">
  @ items=[1, 2, 3]
</div>

***说明：***

<span style="color:#FF5733;">[1, 2, 3] </span>是一个 <span style="color:#FF5733;">valueList</span>，包含三个 <span style="color:#FF5733;">exprNode</span>。

### 5. valueList 规则
__规则定义:__ 

<span style="color:#FF5733;">valueList = exprNode {',' exprNode} ;</span>

__说明:__

<span style="color:#FF5733;">valueList</span> 是一个或多个 <span style="color:#FF5733;">exprNode</span>，用逗号分隔，逗号周围可以有空白字符。

__示例:__

1. 单个值:

<div style="background-color:#fafad2;padding:10px;border-radius:5px;">
  [title]
</div>

***说明：***

<span style="color:#FF5733;">valueList</span> 只包含一个 <span style="color:#FF5733;">exprNode</span>，即 title。

2. 多个值:

<div style="background-color:#fafad2;padding:10px;border-radius:5px;">
  [1, 'text', true]
</div>


***说明：***

包含三个 <span style="color:#FF5733;">exprNode</span>，分别是整数 <span style="color:#FF5733;">1</span>、字符串 <span style="color:#FF5733;">'text'</span> 和布尔值 <span style="color:#FF5733;">true</span>。

3. 带空白的多个值:

<div style="background-color:#fafad2;padding:10px;border-radius:5px;">
  [1 , 'text' , true]
</div>

***说明：***

逗号前后有空白字符，符合 , 规则。

### 6. exprNode 规则
__规则定义:__

<span style="color:#FF5733;">exprNode = orBinaryOp , '?' , orBinaryOp , ws , ':' , ws , orBinaryOp
| orBinaryOp ;</span>

__说明:__

<span style="color:#FF5733;">exprNode</span> 可以是一个三元表达式（<span style="color:#FF5733;">orBinaryOp ? orBinaryOp : orBinaryOp</span>）或单个 <span style="color:#FF5733;">orBinaryOp</span>。

__示例:__

1. 三元表达式:

<div style="background-color:#fafad2;padding:10px;border-radius:5px;">
  ${isActive ? 'on' : 'off'}
</div>

***说明：***

<span style="color:#FF5733;">isActive</span> 是第一个 <span style="color:#FF5733;">orBinaryOp，'on' </span>和 <span style="color:#FF5733;">'off'</span> 是后续的 <span style="color:#FF5733;">orBinaryOp</span>，组成三元表达式。

2. 单个 orBinaryOp:

<div style="background-color:#fafad2;padding:10px;border-radius:5px;">
  ${title}
</div>

***说明：***

<span style="color:#FF5733;">title</span> 是一个简单的 <span style="color:#FF5733;">orBinaryOp</span>（最终解析为 id）。

### 7. orBinaryOp 规则
__规则定义:__

<span style="color:#FF5733;">orBinaryOp = andBinaryOp {, '||', andBinaryOp};</span>

__说明:__

<span style="color:#FF5733;">orBinaryOp</span> 是一个或多个 <span style="color:#FF5733;">andBinaryOp</span>，用 || 分隔。

__示例:__

1. 单个 andBinaryOp:

<div style="background-color:#fafad2;padding:10px;border-radius:5px;">
  ${title}
</div>

***说明：***

仅包含一个 andBinaryOp（最终解析为 id）。

2. 多个 andBinaryOp 使用 ||:

<div style="background-color:#fafad2;padding:10px;border-radius:5px;">
  ${isActive || isVisible}
</div>


***说明：***

<span style="color:#FF5733;">isActive</span> 和 <span style="color:#FF5733;">isVisible</span> 是两个 <span style="color:#FF5733;">andBinaryOp</span>，用 || 连接。

### 8. andBinaryOp 规则
__规则定义:__

<span style="color:#FF5733;">andBinaryOp = inBinaryOp {, '&&', inBinaryOp};</span>

__说明:__

<span style="color:#FF5733;">andBinaryOp</span> 是一个或多个 <span style="color:#FF5733;">inBinaryOp</span>，用 <span style="color:#FF5733;">&&</span> 分隔。

__示例:__

1. 单个 inBinaryOp:

<div style="background-color:#fafad2;padding:10px;border-radius:5px;">
  ${title}
</div>

***说明：***

仅包含一个 inBinaryOp。

2. 多个 inBinaryOp 使用 &&:

<div style="background-color:#fafad2;padding:10px;border-radius:5px;">
  ${isActive && isVisible}
</div>

***说明：***

<span style="color:#FF5733;">isActive</span> 和 <span style="color:#FF5733;">isVisible</span> 是两个 <span style="color:#FF5733;">inBinaryOp</span>，用 <span style="color:#FF5733;">&&</span> 连接。

### 9. inBinaryOp 规则
__规则定义:__ 

<span style="color:#FF5733;">inBinaryOp = comparisonOp [, 'in', comparisonOp];</span>

__说明:__

<span style="color:#FF5733;">inBinaryOp</span> 是一个 <span style="color:#FF5733;">comparisonOp</span>，后面可以选择性地跟 <span style="color:#FF5733;">in</span> 和另一个 <span style="color:#FF5733;">comparisonOp</span>。

__示例:__

1. 单个 comparisonOp:

<div style="background-color:#fafad2;padding:10px;border-radius:5px;">
  ${count}
</div>

***说明：***

仅包含一个 <span style="color:#FF5733;">comparisonOp</span>（最终解析为 id）。

2. 使用 in 操作符:

<div style="background-color:#fafad2;padding:10px;border-radius:5px;">
    <p>${item in items}</p>
    <p>${'a' in 'abc'}      //true</p>
    <p>${'ab' in 'abc'}    //true</p>
    <p>${'bc' in 'abc'}    //true</p>
    <p>${'abc' in 'abc'}  //true</p>
    <p>${'d' in 'abc'}      //false</p>

/*[100, 200, 300, 400, 500]*/
${100 in myArray}   //true 
${300 in myArray}   //true
${1 in myArray}       //false
//检测Map是否存在key
///logic.js
use(function () {
    return {
        a: true,
        b: 'two',
        c: 3
    };
});

<p><sly data-sly-use.logic="logic.js" /></p>
<p>${'a' in logic} <!--/* returns true */--></p>
<p>${'b' in logic} <!--/* returns true */--></p>
<p>${'c' in logic} <!--/* returns true */--></p>
<p>${'two' in logic} <!--/* returns false */--></p>

</div>

***说明：***

item 和 items 是两个 comparisonOp，用 in 连接。

### 10. comparisonOp 规则
__规则定义:__

<span style="color:#FF5733;">comparisonOp = factor [, comparisonOperator, factor];</span>

__说明:__

<span style="color:#FF5733;">comparisonOp</span> 是一个 <span style="color:#FF5733;">factor</span>，后面可以选择性地跟一个比较操作符和另一个 <span style="color:#FF5733;">factor</span>。

__示例:__

1. 单个 factor:

<div style="background-color:#fafad2;padding:10px;border-radius:5px;">
  ${count}
</div>

***说明：***

仅包含一个 factor（最终解析为 id）。

2. 比较操作:

<div style="background-color:#fafad2;padding:10px;border-radius:5px;">
  ${count > 10}
</div>

***说明：***

count 和 10 是两个 factor，> 是 comparisonOperator。

3. 多种比较操作符:

<div style="background-color:#fafad2;padding:10px;border-radius:5px;">
    <p>${count <= 100}</p>
    <p>${value == 'test'}</p>
    <p>${score != 0}</p>
</div>

***说明：***

分别展示了 <=, ==, != 等比较操作符。

### 11. comparisonOperator 规则
__规则定义:__

<span style="color:#FF5733;">comparisonOperator = '<'
| '<='
| '=='
| '>='
| '>'
| '!=' ;</span>

__说明:__

<span style="color:#FF5733;">comparisonOperator</span> 是比较操作符之一。

__示例:__

1. 所有比较操作符:


<div style="background-color:#fafad2;padding:10px;border-radius:5px;">
    <p>${a < b}</p>
    <p>${a <= b}</p>
    <p>${a == b}</p>
    <p>${a >= b}</p>
    <p>${a > b}</p>
    <p>${a != b}</p>
</div>

***说明：***

展示了所有可能的比较操作符。

### 12. factor 规则
__规则定义:__

<span style="color:#FF5733;">factor = term | '!' , term ;</span>

__说明:__

factor 是一个 term，或者一个带有逻辑非 ! 的 term。

__示例:__

1. 单个 term:

<div style="background-color:#fafad2;padding:10px;border-radius:5px;">
  ${title}
</div>

***说明：***

title 是一个 term。

2. 使用逻辑非:

<div style="background-color:#fafad2;padding:10px;border-radius:5px;">
  ${!isActive}
</div>

***说明：***

! 应用于 term（isActive）。

### 13. term 规则
__规则定义:__

<span style="color:#FF5733;">term = propertyAccess | '(' , exprNode , ')' | '[', valueList, ']' ;</span>

__说明:__

<span style="color:#FF5733;">term</span> 可以是一个 <span style="color:#FF5733;">propertyAccess</span>（属性访问）、括号包裹的 <span style="color:#FF5733;">exprNode</span>，或一个 <span style="color:#FF5733;">valueList</span> 数组。

__示例:__

1. 属性访问:

<div style="background-color:#fafad2;padding:10px;border-radius:5px;">
  ${user.name}
</div>

***说明：***

<span style="color:#FF5733;">user.name</span> 是一个 <span style="color:#FF5733;">propertyAccess</span>。

2. 括号表达式:

<div style="background-color:#fafad2;padding:10px;border-radius:5px;">
  ${(a > b)}
</div>

***说明：***

<span style="color:#FF5733;">(a > b)</span> 是一个括号包裹的 <span style="color:#FF5733;">exprNode</span>。

3. 数组:

<div style="background-color:#fafad2;padding:10px;border-radius:5px;">
  ${[1, 2, 3]}
</div>

***说明：***

<span style="color:#FF5733;">[1, 2, 3]</span> 是一个 <span style="color:#FF5733;">valueList</span>。




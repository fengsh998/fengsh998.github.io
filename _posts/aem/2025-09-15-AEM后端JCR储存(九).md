---
layout: post
title: "AEM开发系列【后端】- JCR储存(九)"
categories: AEM开发系列
tags: AEM
author: fengsh998
typora-root-url: ..
---

AME 中的JCR 主要负责底层内容的持久化，存储，搜索，访问控制等功能。
然而对于AEM而言，http://localhost:4502/crx/de/index.jsp 的CRX平台就一个JCR.

更详细了解[JCR的官方网站](https://developer.adobe.com/experience-manager/reference-materials/spec/jcr/2.0/index.html)

JCR中最重要的就是结点类型：[（jcr:primaryType）](https://developer.adobe.com/experience-manager/reference-materials/spec/jcr/2.0/3_Repository_Model.html#3.7.4.1%20Required%20Primary%20Node%20Types)

1. **nt:base**这是所有节点类型的基类，所有其他节点类型都直接或间接继承自它。它定义了节点的基本属性和行为，是JCR节点类型体系的核心。

2. **nt:unstructured**一种灵活的节点类型，允许节点存储任意属性和子节点。它通常用于存储非结构化数据，比如用户自定义内容。

3. **nt:file**用于表示文件节点，通常包含一个名为 jcr:content 的子节点，该子节点存储文件的实际内容。这种类型适用于存储二进制文件，如图片或文档。

4. **nt:folder**用于表示文件夹节点，类似于文件系统中的目录。它可以包含其他文件或文件夹节点，用于组织内容。

5. **nt:resource**用于表示资源节点，通常作为 nt:file 的子节点，存储文件的实际内容或二进制数据

演示一个使用SlingPostServlet怎么进行创建结点的过程。如想专们学习这块，可以通过https://sling.apache.org/downloads.cgi 官方下载Sling Launchpad 工具进行学习。还好有AEM，就索性通过AEM的crx/de/index.jsp 的(实质就是一个Sling Launchpad)进行演示。
![img](/assets/articles/aem/jcr/jcr-1.png)

表单代码(样式暂时不管)：
```html
    <form action="/content/fsh/mynode" method="POST">
        <label for="title">标题:</label>
        <input type="text" id="title" name="title" placeholder="输入标题...">

        <label for="body">内容:</label>
        <textarea id="body" name="body" rows="10" placeholder="输入内容..."></textarea>

        <button type="submit">提交并创建节点</button>
    </form>
```
把上面代码，套在一个html页中显示：
![img](/assets/articles/aem/jcr/jcr-2.jpg)

**创建或更新结点（如果第一次则创建，后面的都是update）**

由于我是在localhost:4502上随便找一个页面加中的这段form,所以当我输入标题、内容后点击“提交并创建节点按钮”时，将会在crx/de/index.jsp 的创建/content/fsh/mynode这样的一个mynode文件夹结点。

![img](/assets/articles/aem/jcr/jcr-3.jpg)

如果改为"/fsh/mynode",则创建的是nt:unstructed结点。（回头研究下文件夹路径结点和 unstructed结点）

![img](/assets/articles/aem/jcr/jcr-4.jpg)

再次输入再提交则就是修改，同时浏览器会响应：

![img](/assets/articles/aem/jcr/jcr-5.jpg)

**创建子结点：**
```html
<p>下面的是创建子结点演</p>
    <form action="/fsh/mynode/" method="POST">
        <input type="text" name="dummy">
        <input type="hidden" name=":order" value="first">
        <button type="submit">创建子节点</button>
    </form>
```

其中<input type="hidden" name=":order" value="first"> 是隐藏字段，POST时一会被会到服务端，服务端会将这个:order解释为创建的顺序规则：value值可以有 first,last, before x, after x, 有点类似在什么地方插入子结点的意思。

![img](/assets/articles/aem/jcr/jcr-6.jpg)

![img](/assets/articles/aem/jcr/jcr-7.jpg)
可以指定节点的名称
```html
<p>下面的是创建子结点演(指定结点名称)</p>
    <form action="/fsh/mynode/" method="POST">
        <input type="hidden" name=":name" value="sub_title">
        <input type="hidden" name=":nameHint" value="sub title node">
        <button type="submit">创建指定名称子节点</button>
    </form>
```

![img](/assets/articles/aem/jcr/jcr-8.jpg)

**before示例**

![img](/assets/articles/aem/jcr/jcr-9.jpg)

如果改为"<input type="hidden" name=":order" value="before 2_1756633629562">"

![img](/assets/articles/aem/jcr/jcr-10.jpg)

**删除结点：**

```html
<p>下面是删除结点</p>
    <form action="/fsh/mynode/2_1756633629562" method="POST">
        <input name=":operation" type="hidden" value="delete">
        <button type="submit">删除节点</button>
    </form>
```
删除/fsh/mynode下的2_1756633629562结点

**删除指定的子结点**
```html
<p>下面是删除子结点</p>
    <form action="/fsh/mynode/sub_title" method="POST">
    	<input type="hidden" name=":operation" value="delete">
    	<input type="hidden" name=":applyTo" value="/fsh/mynode/sub_title/one">
    	<input type="hidden" name=":applyTo" value="/fsh/mynode/sub_title/two">
        <button type="submit">删除子节点</button>
    </form>
```
这里指定了要删除one,two这两个子结点

![img](/assets/articles/aem/jcr/jcr-11.jpg)

删除后的结果：

![img](/assets/articles/aem/jcr/jcr-12.jpg)

**添加及删除节点的属性**
```html
<p>添加及删除节点的属性</p>
    <form action="/fsh/mynode/sub_title/three" method="POST">
    	<input type="text" name="customer">
		<input type="hidden" value="John Doe" name="customer@DefaultValue">
        <input type="hidden" name="title@Delete">
        <button type="submit">提交</button>
    </form>
```
删除前：把title属性删除，同时添加customer属性，如果没有输入值时，默认值为John Doe

![img](/assets/articles/aem/jcr/jcr-13.jpg)

执行提交后：

![img](/assets/articles/aem/jcr/jcr-14.png)

![img](/assets/articles/aem/jcr/jcr-15.jpg)

**移动节点：**

```html
<p>移动结点</p>
    <form action="/fsh/mynode/sub_title/three" method="POST">
		<input type="hidden" name=":operation" value="move">
		<input type="hidden" name=":dest" value="/fsh/mynode/">
        <button type="submit">提交</button>
    </form>
```

移动前的结点：/fsh/mynode/sub_title/three 
移动到：/fsh/mynode/
移动前：
![img](/assets/articles/aem/jcr/jcr-16.jpg)

移动后：

![img](/assets/articles/aem/jcr/jcr-17.jpg)

**复制节点：**
```html
<p>复制结点</p>
	<form action="/fsh/mynode/three" method="POST">
		<input type="hidden" name=":operation" value="copy">
		<input type="hidden" name=":dest" value="/fsh/mynode/sub_title/">
       <!-- 是否复盖 -->
		<input type="hidden" name=":replace" value="true">
      <button type="submit">提交</button>
	</form>
```

**提交属性值时，可以指定新属性使用输入的值作为新属性的值**
```html
<p>设置值</p>
    <form action="/fsh/mynode/three" method="POST">
    	<input type="text" name="oldtitle">
		<input type="hidden" value="oldtitle" name="newtitle@ValueFrom">
        <button type="submit">提交</button>
    </form>
```
即/fsh/mynode/three结点存在属性oldtitle，此时如果用户输入值后，则在修改该节点的oldtitle的属性值的同时，会创建一个属性newtitle，且此时使用的的是oldtitle输入的值。

**复制某个结点的值作为自己节点下的属性值**
```html
<input type="hidden" value="/node/prop" name="title@CopyFrom">
```

![img](/assets/articles/aem/jcr/jcr-18.png)
这个部分就不演示了，意思是当输入值内容时生成的属性会根据值的情况来推导出属性的最终类型。

总结：
虽然大多情况下可以通过直接的slingPostServlet进行对jcr的操作。在AEM中建议使用sling:sourceType的方式进行处理（即通过页面组件的方式进行处理）。

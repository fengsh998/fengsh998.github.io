---
layout: post
title: "STM32(自学)-四种库对比寄存器、标准外设库、HAL、LL(四)"
categories: STM32
tags: STM32
author: fengsh998
typora-root-url: ..
---

1. 基本概念

* **寄存器操作**：直接读写 MCU 的硬件寄存器（如通过 CMSIS 定义的结构体访问）。无任何封装，相当于“裸机”编程。
* **标准外设库 (SPL)**：ST 早期库，对寄存器进行简单 C 函数封装，提供外设驱动（如 GPIO、UART）。已停更，仅支持旧系列（如 F0/F1/F2/F3/F4/L1）。
* **HAL 库 (Hardware Abstraction Layer)**：ST 当前主推的高级抽象层，提供统一 API 接口，支持所有 STM32 系列。隐藏硬件细节，便于 CubeMX 工具生成代码。
* **LL 库 (Low Layer)**：与 HAL 捆绑发布的中低级库，直接操作寄存器，但以 inline 函数形式封装。支持大多数系列（如 F0/F3/F4/L0/L4 等），部分新系列（如 L5/G4）逐步完善。

2. 详细对比表

|维度|寄存器操作|标准外设库 (SPL)|HAL 库|LL 库|
|---|---|----|----|---|
|抽象程度|最低：直接访问寄存器（如 <font color="red">GPIOA->ODR = 0x01）</font>|低：简单函数封装寄存器（如 <font color="red">GPIO_SetBits</font>）|高：面向功能 API（如 <font color="red">HAL_GPIO_WritePin</font>），隐藏寄存器细节|中低：inline 函数直接改寄存器（如<font color="red"> LL_GPIO_SetOutputPin</font>）|
|代码效率/性能|最高：无开销，执行最快（e.g., GPIO 翻转 ~10 ns）|高：接近寄存器，效率好（e.g., PWM 输出 ~50 ns）|中等：有状态机/回调，稍慢（e.g., ADC DMA ~200 ns），代码体积大|高：原子操作，无状态机（e.g., DMA M2M ~80 ns），体积小|
|可移植性|低：需手动适配不同 MCU 寄存器布局|低：仅限特定系列（如 F1 vs F4 需重写）|最高：统一 API，跨系列（如 F1 到 H7）无缝移植|中高：寄存器级，但需查手册；与 HAL 混用|
|开发难度|最高：需熟读参考手册（RM），易出错|中高：需懂总线/寄存器，调试较易|最低：API 简单，CubeMX 自动生成|中等：比 HAL 快，但需硬件知识；适合 SPL 用户过渡|
|支持系列|所有（通用）|旧系列（F0/F1/F2/F3/F4/L1），已停更|所有（F0 到 H7、G0/L5 等）|大多数（F0/F3/F4/L0/L4 等），新系列逐步支持|
|内存/资源占用|最低：无额外库|低：小体积|高：大（~20-50% 更多 Flash/RAM）|低：无状态保存，接近寄存器|
|中断/回调支持|手动写 ISR|基本中断函数|丰富：内置回调、状态机|基本：直接寄存器清中断，无回调|
|工具集成|无（手动）|Keil/IAR 等旧 IDE|优秀：CubeMX 图形配置|与 HAL/CubeMX 集成，可混用
适用场景|高性能/实时系统、资深开发者（如裸机优化）|旧项目迁移、中等性能需求|快速原型、团队开发、多系列移植|性能敏感但需封装（如实时控制、SPL 替代）|
|优缺点|+ 灵活/高效<br>- 易错/耗时|+ 高效/简单<br>- 已停更/不移植|+ 易用/移植好<br>- 慢/大|+ 高效/独立<br>- 需硬件知识/覆盖不全|

>学习路径：先 HAL 入门（懂 API），再 LL（懂寄存器），最后寄存器（深挖 RM）。
{: .prompt-tips }

3. 手册查阅：

寄存器操作 (Register Programming):
 - **直接操作寄存器需参考 MCU 的参考手册 (Reference Manual, RMxxxx)**（详细寄存器映射）和编程手册 (Programming Manual, PMxxxx)（Cortex-M 核心通用）。(如 F1 用 RM0008)。
 - **标准外设库 (SPL - Standard Peripheral Library)**，标准库文档[官方下载连接](https://www.st.com/en/embedded-software/stm32-standard-peripheral-libraries.html),在线函数和结构体定义(http://stm32.kosyak.info/doc/struct_a_d_c___type_def.html)
 - **HAL 库 (Hardware Abstraction Layer)**,HAL 的 API 手册是“Description of STM32xx HAL and Low-Layer Drivers” (UMxxxx)，包含函数原型、参数和示例。[官方链接](https://www.st.com.cn/zh/embedded-software/stm32cube-mcu-mpu-packages.html)->文件->用户手册(User Manuals),查看最新的文档。
 - LL 库 (Low Layer)，LL 的 API 与 HAL 共享同一手册（UMxxxx），LL 部分描述寄存器级 inline 函数，详见 HAL 手册的 Low-Layer 章节。


纯裸机只用寄存器的方式最小工程结构：

        project/
        ├─ src/          main.c
        ├─ inc/          stm32f1xx.h、system_stm32f10x.h
        ├─ startup/      startup_stm32f103xb.s 
        ├─ linker/       STM32F103C8Tx_FLASH.ld
        └─ Makefile

关键文件（寄存器级必须的）
* startup_stm32f103xb.s（启动文件）
  - 负责 向量表、复位入口、堆栈初始化。
  - 直接复制 CubeMX 生成的即可（或从官方 GitHub 下载）。
* system_stm32f10x.c（系统时钟）
  - 初始化 RCC、Flash、PLL，把系统时钟配置为 72 MHz（F103 最高）。
  - 必须保留，否则默认 8 MHz HSI，跑不快。
* stm32f1xx.h（CMSIS 寄存器映射）


> 裸机必记口诀: 适用任何 STM32 上用 纯寄存器 点亮 LED、驱动外设、写中断。
> 
> 时钟 → 使能 → 配置 → 操作 → 循环
>
> RCC  → APB2ENR → CRL/CRH → BSRR/BRR → while(1)
{: .prompt-tips }